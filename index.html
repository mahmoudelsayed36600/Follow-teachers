<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة المعلمين - النسخة السحابية</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f6f9; overflow-x: hidden; }
        
        /* Sidebar Styling */
        .sidebar {
            height: 100vh; width: 260px; position: fixed; top: 0; right: 0;
            background-color: #212529; padding-top: 20px; color: white;
            transition: 0.3s; z-index: 1000; box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .sidebar a {
            padding: 12px 20px; text-decoration: none; font-size: 14px; color: #adb5bd;
            display: block; transition: 0.2s; border-right: 3px solid transparent;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #343a40; color: #fff; border-right-color: #0d6efd;
        }
        .sidebar .user-info {
            text-align: center; padding-bottom: 20px; border-bottom: 1px solid #343a40; margin-bottom: 20px;
        }

        /* Content Styling */
        .main-content { margin-right: 260px; padding: 30px; transition: 0.3s; }
        
        /* Login Page */
        #login-section {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(135deg, #0d6efd, #6610f2); position: fixed;
            top: 0; left: 0; width: 100%; z-index: 2000;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2); width: 100%; max-width: 400px;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 3000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        /* Cards & General */
        .section-card {
            background: white; padding: 25px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e9ecef;
        }
        .stat-card {
            border-radius: 10px; padding: 20px; color: white; margin-bottom: 20px;
            position: relative; overflow: hidden;
        }
        .stat-card h3 { font-weight: bold; margin: 0; }
        .stat-card p { margin: 0; opacity: 0.8; }
        .stat-card i { position: absolute; left: 10px; bottom: 10px; opacity: 0.2; font-size: 3rem; }

        .matrix-table th, .matrix-table td { text-align: center; vertical-align: middle; border: 1px solid #dee2e6; font-size: 0.9rem; }
        .matrix-table thead { background-color: #f8f9fa; }
        .checkbox-cell { width: 25px; height: 25px; cursor: pointer; }
        
        .hidden { display: none !important; }
        .action-btn { cursor: pointer; margin-left: 5px; opacity: 0.7; transition: 0.2s; }
        .action-btn:hover { opacity: 1; transform: scale(1.1); }
        .cursor-pointer { cursor: pointer; }

        @media print {
            .sidebar, .no-print, #login-section, .btn, .modal { display: none !important; }
            .main-content { margin-right: 0; padding: 0; width: 100%; }
            .section-card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; }
            body { background-color: white; font-size: 12pt; }
            body.printing-notification * { visibility: hidden; }
            body.printing-notification #print-area-container, body.printing-notification #print-area-container * { visibility: visible; }
            body.printing-notification #print-area-container { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="mt-3 text-secondary">جاري الاتصال بقاعدة البيانات...</h5>
    </div>

    <div class="modal fade" id="missingItemsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle ms-2"></i>البنود غير المرصودة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body"><div id="missing-items-content"></div></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button></div>
            </div>
        </div>
    </div>
    
    <div id="print-area-container" class="d-none"></div>

    <div id="login-section"> 
        <div class="login-card text-center">
            <div class="mb-4"><i class="fas fa-cloud-upload-alt fa-3x text-primary"></i></div>
            <h4 class="mb-4 fw-bold">بوابة المتابعة (للمعلمين)</h4>
            <div class="mb-3 text-end">
                <label class="form-label text-muted small">اسم المستخدم</label>
                <input type="text" id="login-username" class="form-control" placeholder="أدخل اسم المستخدم">
            </div>
            <div class="mb-4 text-end">
                <label class="form-label text-muted small">كلمة المرور</label>
                <input type="password" id="login-password" class="form-control" placeholder="أدخل كلمة المرور">
            </div>
            <button onclick="System.auth.login()" class="btn btn-primary w-100 py-2 fw-bold">تسجيل الدخول</button>
            </div>
    </div>

    <div id="sidebar" class="sidebar hidden">
        <div class="user-info">
            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                <span class="text-white h3 m-0" id="sidebar-initials">M</span>
            </div>
            <h5 id="sidebar-username" class="mb-0">المستخدم</h5>
            <small id="sidebar-role" class="text-muted">الدور</small>
        </div>
        
        <a href="#" onclick="System.ui.showView('view-notifications')" class="position-relative">
            <i class="fas fa-bell ms-2"></i> الإشعارات
            <span id="nav-badge" class="badge bg-danger rounded-pill position-absolute" style="left: 10px; top: 10px;">0</span>
        </a>
        <hr class="border-secondary my-1">
        <div id="sidebar-menu"></div>
        <div class="mt-auto pt-4 px-3 border-top border-secondary">
            <a href="#" onclick="System.auth.logout()" class="text-danger fw-bold"><i class="fas fa-sign-out-alt ms-2"></i>تسجيل خروج</a>
        </div>
    </div>

    <div id="main-content" class="main-content hidden">
        <div class="d-flex justify-content-between align-items-center mb-3 no-print">
            <h4 class="text-secondary" id="page-header-title"></h4>
            <div>
                 <span class="badge bg-light text-dark border me-2"><i class="fas fa-user ms-1"></i> <span id="top-bar-user"></span></span>
                <button onclick="window.print()" class="btn btn-secondary btn-sm"><i class="fas fa-print ms-2"></i>طباعة</button>
            </div>
        </div>

        <div id="view-admin-structure" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-cogs ms-2"></i>تهيئة الهيكل</h3>
            <div class="row">
                <div class="col-lg-6">
                    <div class="section-card">
                        <h5 class="border-bottom pb-2 mb-3">1. الهيكل الإداري</h5>
                        <div class="mb-3 input-group">
                            <input type="text" id="new-school-name" class="form-control" placeholder="اسم المدرسة">
                            <button onclick="System.admin.addSchool()" class="btn btn-success"><i class="fas fa-plus"></i></button>
                        </div>
                        <ul id="schools-list" class="list-group mb-4"></ul>
                        <div class="bg-light p-3 rounded">
                            <label class="form-label small fw-bold">تخصيص الهيكل:</label>
                            <select id="struct-school-select" class="form-select mb-2" onchange="System.ui.updateStagesDropdown()"></select>
                            <div class="input-group mb-2">
                                <input type="text" id="new-stage-name" class="form-control" placeholder="المرحلة">
                                <button onclick="System.admin.addStage()" class="btn btn-primary btn-sm">إضافة</button>
                            </div>
                            <div class="input-group mb-2">
                                <select id="struct-stage-select" class="form-select" onchange="System.ui.updateGradesDropdown()"></select>
                                <input type="text" id="new-grade-name" class="form-control" placeholder="الصف">
                                <button onclick="System.admin.addGrade()" class="btn btn-secondary btn-sm">إضافة</button>
                            </div>
                            <div class="input-group">
                                <select id="struct-grade-select" class="form-select"></select>
                                <input type="text" id="new-class-name" class="form-control" placeholder="الفصل">
                                <button onclick="System.admin.addClass()" class="btn btn-info text-white btn-sm">إضافة</button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6 class="small text-muted">معاينة الهيكل:</h6>
                            <div id="structure-preview" class="border p-2 bg-white rounded" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="section-card">
                        <h5 class="border-bottom pb-2 mb-3">2. المحتوى والبنود</h5>
                        <div class="mb-3">
                            <label class="small text-muted">المواد</label>
                            <div class="input-group"><input type="text" id="new-subject-name" class="form-control"><button onclick="System.admin.addSubject()" class="btn btn-success">+</button></div>
                            <ul id="subjects-list" class="list-group mt-2" style="max-height: 100px; overflow-y: auto;"></ul>
                        </div>
                        <div class="mb-3">
                            <label class="small text-muted">الأسابيع</label>
                            <div class="input-group"><input type="text" id="new-week-name" class="form-control"><button onclick="System.admin.addWeek()" class="btn btn-success">+</button></div>
                            <ul id="weeks-list" class="list-group mt-2" style="max-height: 100px; overflow-y: auto;"></ul>
                        </div>
                        <div>
                            <label class="small text-muted">بنود التقييم</label>
                            <div class="input-group"><input type="text" id="new-criteria-name" class="form-control"><button onclick="System.admin.addCriteria()" class="btn btn-warning">+</button></div>
                            <ul id="criteria-list" class="list-group mt-2"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin-assignments" class="view-section hidden">
            <h3 class="mb-4 text-primary">تسكين المعلمين</h3>
            <div class="section-card border-primary border-start border-4 mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2"><label class="small">المدرسة</label><select id="assign-school" class="form-select form-select-sm" onchange="System.admin.updateAssignStages()"></select></div>
                    <div class="col-md-2"><label class="small">المرحلة</label><select id="assign-stage" class="form-select form-select-sm" onchange="System.admin.updateAssignGrades()"></select></div>
                    <div class="col-md-2"><label class="small">الصف</label><select id="assign-grade" class="form-select form-select-sm" onchange="System.admin.updateAssignClasses()"></select></div>
                    <div class="col-md-2"><label class="small">الفصل</label><select id="assign-class" class="form-select form-select-sm"></select></div>
                    <div class="col-md-2"><label class="small">المعلم</label><select id="assign-teacher" class="form-select form-select-sm"></select></div>
                    <div class="col-md-2"><label class="small">المادة</label><select id="assign-subject" class="form-select form-select-sm"></select></div>
                    <div class="col-12 mt-3"><button onclick="System.admin.saveAssignment()" class="btn btn-primary w-100">ربط</button></div>
                </div>
            </div>
            <div class="section-card">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover"><thead class="table-light"><tr><th>المدرسة</th><th>الصف</th><th>الفصل</th><th>المعلم</th><th>المادة</th><th>حذف</th></tr></thead><tbody id="assignments-table-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-users" class="view-section hidden">
            <h3 class="mb-4 text-primary">إدارة المستخدمين</h3>
            <div class="section-card">
                <input type="hidden" id="user-edit-id"> 
                <div class="row g-3 align-items-end">
                    <div class="col-md-2"><label class="small">الاسم</label><input type="text" id="user-fullname" class="form-control"></div>
                    <div class="col-md-2"><label class="small">المستخدم</label><input type="text" id="user-username" class="form-control"></div>
                    <div class="col-md-2"><label class="small">المرور</label><input type="text" id="user-password" class="form-control"></div>
                    <div class="col-md-2"><label class="small">الجوال</label><input type="text" id="user-mobile" class="form-control"></div>
                    <div class="col-md-2"><label class="small">الدور</label><select id="user-role" class="form-select" onchange="System.ui.toggleUserFields()"><option value="teacher">معلم</option><option value="coordinator">منسق</option><option value="supervisor">مشرف</option><option value="manager">مدير</option><option value="admin">مسؤول</option></select></div>
                    <div class="col-md-2"><button onclick="System.admin.saveUser()" id="btn-save-user" class="btn btn-success w-100">حفظ</button><button onclick="System.admin.cancelEditUser()" id="btn-cancel-user" class="btn btn-secondary w-100 hidden mt-1">إلغاء</button></div>
                </div>
                <div class="mt-3 p-3 bg-light rounded border">
                    <div class="row g-3">
                        <div class="col-md-4"><label class="small">المدرسة:</label><select id="user-school-select" class="form-select" onchange="System.ui.renderScopeOptions()"></select></div>
                        <div class="col-md-4 hidden" id="field-subject"><label class="small">المادة:</label><select id="user-subject-select" class="form-select"></select></div>
                    </div>
                    <div id="scope-container" class="mt-3 hidden"><label class="small fw-bold text-primary">نطاق الإشراف:</label><div id="scope-options" class="d-flex flex-wrap gap-3 bg-white p-2 rounded border"></div></div>
                </div>
                <hr>
                <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-dark"><tr><th>الاسم</th><th>User</th><th>Pass</th><th>الجوال</th><th>الدور</th><th>المدرسة</th><th>إجراء</th></tr></thead><tbody id="users-table-body"></tbody></table></div>
            </div>
        </div>

        <div id="view-coordinator-entry" class="view-section hidden">
            <h3 class="mb-4 text-primary">المتابعة اليومية</h3>
            <div class="section-card">
                <div class="row g-2 mb-3 align-items-end no-print">
                    <div class="col-md-2"><label class="small">المرحلة</label><select id="entry-stage" class="form-select" onchange="System.coordinator.updateEntryGrades()"></select></div>
                    <div class="col-md-2"><label class="small">الصف</label><select id="entry-grade" class="form-select" onchange="System.coordinator.updateEntryClasses()"></select></div>
                    <div class="col-md-2"><label class="small">الفصل</label><select id="entry-class" class="form-select" onchange="System.coordinator.updateEntryTeachers()"></select></div>
                     <div class="col-md-3"><label class="small fw-bold text-primary">المعلم</label><select id="entry-teacher" class="form-select" onchange="System.coordinator.updateEntrySubjects()"></select></div>
                    <div class="col-md-3"><label class="small fw-bold text-primary">المادة</label><select id="entry-subject" class="form-select"></select></div>
                    <div class="col-md-2"><label class="small">الأسبوع</label><select id="entry-week" class="form-select"></select></div>
                    <div class="col-md-3"><label class="small">التاريخ</label><input type="date" id="entry-date" class="form-control"></div>
                    <div class="col-md-3"><button onclick="System.coordinator.loadMatrix()" class="btn btn-dark w-100">بحث</button></div>
                </div>
                <div id="matrix-container" class="hidden">
                    <h5 id="matrix-title" class="text-center text-primary mb-3 mt-4"></h5>
                    <div class="table-responsive"><table class="table matrix-table table-bordered table-striped" id="matrix-table"><thead class="table-light"></thead><tbody></tbody></table></div>
                    <button onclick="System.coordinator.saveMatrix()" id="btn-save-matrix" class="btn btn-success mt-3 w-100 no-print fw-bold">حفظ التقييم</button>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view-section hidden">
            <h3 class="mb-4 text-primary">حالة الرصد</h3>
            <div class="row mb-4" id="general-stats-row"></div>
            <div class="section-card bg-white border-top border-4 border-info">
                <div class="d-flex align-items-center mb-3 text-info"><i class="fas fa-chart-pie fa-2x me-2"></i><h5 class="m-0 fw-bold">نسبة تفعيل البنود</h5></div>
                <div class="row g-2 mb-3 bg-light p-3 rounded align-items-end">
                    <div class="col-md-3"><label class="small fw-bold">المدرسة</label><select id="stats-school" class="form-select form-select-sm" onchange="System.dashboard.updateStatsFilters('school')"><option value="all">الجميع</option></select></div>
                    <div class="col-md-3"><label class="small fw-bold">الصف</label><select id="stats-grade" class="form-select form-select-sm" onchange="System.dashboard.updateStatsFilters('grade')"><option value="all">الجميع</option></select></div>
                    <div class="col-md-3"><label class="small fw-bold">الفصل</label><select id="stats-class" class="form-select form-select-sm"><option value="all">الجميع</option></select></div>
                    <div class="col-md-3"><button class="btn btn-info text-white btn-sm w-100" onclick="System.dashboard.renderCriteriaStats()">عرض النسب</button></div>
                </div>
                <div class="table-responsive"><table class="table table-bordered table-sm text-center align-middle" id="criteria-stats-table"><thead class="table-secondary"><tr><th>البند</th><th>التفعيل</th><th>الزيارات</th><th>النسبة %</th></tr></thead><tbody></tbody></table></div>
            </div>
            <div class="row g-2 mb-3 no-print">
                <div class="col-md-3"><select id="dash-week" class="form-select" onchange="System.dashboard.renderMonitoringStatus()"></select></div>
                <div class="col-md-3"><button class="btn btn-primary" onclick="System.dashboard.renderMonitoringStatus()">تحديث الحالة</button></div>
            </div>
            <div class="section-card">
                <h5 class="mb-3">الفصول غير المكتملة</h5>
                <div class="table-responsive"><table class="table table-bordered table-hover" id="monitoring-table"><thead class="table-danger"><tr><th>المرحلة</th><th>الفصل</th><th>الأسبوع</th><th>المادة</th><th>المعلم</th><th>المنسق</th><th>النقص</th><th>مراسلة</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="view-notifications" class="view-section hidden">
            <h3 class="mb-4 text-primary">الإشعارات</h3>
            <div class="d-flex justify-content-end mb-3 no-print"><button class="btn btn-secondary" onclick="System.utils.printAllNotifications()">طباعة الكل</button></div>
            <div class="row">
                <div class="col-md-4"><div class="card bg-primary text-white mb-3"><div class="card-body text-center"><h1 class="display-4 fw-bold" id="notif-count-display">0</h1><p>الإشعارات المرسلة</p></div></div></div>
                <div class="col-md-8"><div class="section-card"><h5 class="mb-3">سجل التواصل</h5><ul class="list-group" id="notif-list"></ul></div></div>
            </div>
        </div>

        <div id="view-procedures" class="view-section hidden">
            <h3 class="mb-4 text-primary">إجراءات المعلمين</h3>
            <div class="section-card no-print">
                <div class="row g-3">
                    <div class="col-md-4"><label class="small">المعلم</label><select id="proc-teacher" class="form-select"></select></div>
                    <div class="col-md-2"><label class="small">النوع</label><select id="proc-type" class="form-select"><option value="praise">شكر</option><option value="note">ملاحظة</option><option value="verbal_warning">تنبيه شفهي</option><option value="written_warning">تنبيه كتابي</option><option value="violation">مخالفة</option></select></div>
                    <div class="col-md-3"><label class="small">التاريخ</label><input type="date" id="proc-date" class="form-control"></div>
                    <div class="col-md-3"><label class="small">اليوم</label><input type="text" id="proc-day" class="form-control"></div>
                    <div class="col-md-6"><textarea id="proc-situation" class="form-control" rows="2" placeholder="الموقف"></textarea></div>
                    <div class="col-md-6"><textarea id="proc-action" class="form-control" rows="2" placeholder="الإجراء"></textarea></div>
                    <div class="col-12"><button onclick="System.procedures.add()" class="btn btn-warning text-dark w-100 fw-bold">حفظ</button></div>
                </div>
            </div>
            <div class="section-card">
                <div class="table-responsive"><table class="table table-striped" id="procedures-table"><thead class="table-dark"><tr><th>المعلم</th><th>النوع</th><th>التاريخ</th><th>الموقف</th><th>الإجراء</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="view-teacher-file" class="view-section hidden">
            <h3 class="mb-4 text-primary">ملف المعلم</h3>
            <div class="row mb-3 no-print"><div class="col-md-6"><select id="file-teacher-select" class="form-select" onchange="System.teacherFile.render()"><option value="">اختر المعلم...</option></select></div></div>
            <div id="teacher-file-content" class="hidden">
                <div class="section-card border-top border-5 border-primary">
                    <div class="d-flex justify-content-between"><h4 id="tf-name">الاسم</h4><span id="tf-school" class="badge bg-secondary">المدرسة</span></div>
                    <div class="row mt-4 text-center">
                        <div class="col-md-4"><div class="card bg-success text-white p-3"><h3 id="tf-praise-count">0</h3><small>ثناء</small></div></div>
                        <div class="col-md-4"><div class="card bg-danger text-white p-3"><h3 id="tf-violation-count">0</h3><small>مخالفات</small></div></div>
                        <div class="col-md-4"><div class="card bg-warning text-dark p-3"><h3 id="tf-gaps-count">0</h3><small>نواقص</small></div></div>
                    </div>
                </div>
                <div class="section-card">
                    <ul class="nav nav-tabs mb-3" id="teacherFileTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active text-danger" id="tab-gaps-btn" data-bs-toggle="tab" data-bs-target="#tab-gaps" type="button">النواقص</button></li>
                        <li class="nav-item"><button class="nav-link text-dark" id="tab-violations-btn" data-bs-toggle="tab" data-bs-target="#tab-violations" type="button">المخالفات</button></li>
                        <li class="nav-item"><button class="nav-link text-success" id="tab-positive-btn" data-bs-toggle="tab" data-bs-target="#tab-positive" type="button">التميز</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-gaps" role="tabpanel"><div class="table-responsive"><table class="table table-bordered table-striped" id="table-gaps"><thead class="table-light"><tr><th>الفصل</th><th>الأسبوع</th><th>المادة</th><th>التاريخ</th><th>عدد النواقص</th><th>تفاصيل</th><th>الأداء %</th></tr></thead><tbody></tbody></table></div></div>
                        <div class="tab-pane fade" id="tab-violations" role="tabpanel"><div class="table-responsive"><table class="table table-bordered" id="table-violations"><thead class="table-dark"><tr><th>النوع</th><th>التاريخ</th><th>الموقف</th><th>الإجراء</th></tr></thead><tbody></tbody></table></div></div>
                        <div class="tab-pane fade" id="tab-positive" role="tabpanel"><div class="table-responsive"><table class="table table-bordered table-success" id="table-praise"><thead class="bg-success text-white"><tr><th>السياق</th><th>التاريخ</th><th>النوع</th><th>السبب</th><th>الإجراء</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section hidden">
            <h3 class="mb-4 text-primary">التقارير</h3>
            <div class="section-card">
                <div class="row g-2 mb-4 no-print bg-light p-3 rounded border" id="report-filters">
                    <div class="col-md-3"><label class="small fw-bold">الأسبوع</label><select id="rep-week" class="form-select form-select-sm"><option value="all">الكل</option></select></div>
                    <div class="col-md-9 d-flex align-items-end"><button onclick="System.reports.generate()" class="btn btn-primary btn-sm w-100">عرض التقرير</button></div>
                </div>
                <ul class="nav nav-tabs mb-3 no-print" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#stats" type="button">إحصائيات</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#perf" type="button">الأداء</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#data" type="button">بيانات</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="stats" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4 mb-3"><div class="card p-2"><h6 class="text-center">الأداء العام</h6><canvas id="chart-pie"></canvas></div></div>
                            <div class="col-md-8 mb-3"><div class="card p-2"><h6 class="text-center">أفضل المعلمين</h6><canvas id="chart-bar"></canvas></div></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="perf" role="tabpanel"><div class="table-responsive"><table class="table table-bordered table-striped" id="report-table"><thead class="table-light"><tr><th>المعلم</th><th>المادة</th><th>الحصص</th><th>البنود المفعلة</th><th>الإنجاز %</th></tr></thead><tbody></tbody></table></div></div>
                    <div class="tab-pane fade" id="data" role="tabpanel"><div class="table-responsive"><table class="table table-bordered table-sm small" id="detailed-data-table"><thead class="table-dark"><tr><th>التاريخ</th><th>المعلم</th><th>المادة</th><th>الفصل</th><th>مفعل</th><th>غير مفعل</th></tr></thead><tbody></tbody></table></div></div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- ضع إعدادات FIREBASE الخاصة بك هنا ---
        const firebaseConfig = {
            apiKey: "AIzaSyBccRKZbS8IEmHUSVTuyWeA9Occ7ZcJJBw",
            authDomain: "https://following-app-2942a-default-rtdb.firebaseio.com",
            projectId: "following-app-2942a",
            storageBucket: "following-app-2942a.firebasestorage.app",
            messagingSenderId: "980788870418",
            appId: "1:980788870418:web:73ba8857ce2ee751a547cb"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const dbRef = doc(db, "schoolSystem", "mainDatabase_v1");

        // Logic
        const defaultData = {
            users: [{id: 1, name: 'Admin', username: 'admin', password: 'Ma@521990', role: 'admin', mobile: '966500000000', schoolId: null, scope: {}}],
            schools: [], subjects: [], weeks: [],
            criteria: [{id: 'c1', name: 'تحضير الدروس'}, {id: 'c2', name: 'استخدام التقنية'}, {id: 'c3', name: 'الواجبات'}, {id: 'c4', name: 'المشاركة الصفية'}],
            assignments: [], evaluations: [], procedures: [], notifications: []
        };

        const System = {
            data: null,
            currentUser: null,
            charts: {},

            init: async function() {
                // Show Loading
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                try {
                    const docSnap = await getDoc(dbRef);
                    if (docSnap.exists()) {
                        this.data = docSnap.data();
                    } else {
                        this.data = JSON.parse(JSON.stringify(defaultData));
                        await setDoc(dbRef, defaultData);
                    }

                    // Check Admin
                    if (!this.data.users.find(u => u.role === 'admin')) {
                        this.data.users.push(defaultData.users[0]);
                        this.save();
                    }

                    const sessionUser = sessionStorage.getItem('currentUser');
                    if (sessionUser) {
                        this.currentUser = JSON.parse(sessionUser);
                        // Refresh user data from DB to ensure roles/settings are current
                        const freshUser = this.data.users.find(u => u.id === this.currentUser.id);
                        if(freshUser) {
                            this.currentUser = freshUser;
                            sessionStorage.setItem('currentUser', JSON.stringify(freshUser));
                            this.auth.postLoginInit();
                        } else {
                            this.auth.logout();
                        }
                    } else {
                         // Ensure login screen is visible
                        document.getElementById('login-section').classList.remove('hidden');
                        document.getElementById('sidebar').classList.add('hidden');
                        document.getElementById('main-content').classList.add('hidden');
                    }

                } catch (error) {
                    console.error("Firebase Error:", error);
                    alert("حدث خطأ في الاتصال بقاعدة البيانات. يرجى التأكد من الإنترنت أو إعدادات Firebase.");
                } finally {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            },

            save: async function() {
                // Optimistic UI update, then background save
                try {
                    await setDoc(dbRef, this.data);
                    // alert("تم الحفظ في السحابة"); // Optional: Feedback
                } catch(e) {
                    console.error("Save Error", e);
                    alert("فشل الحفظ في قاعدة البيانات!");
                }
            },

            auth: {
                login: function() {
                    const u = document.getElementById('login-username').value;
                    const p = document.getElementById('login-password').value;
                    const user = System.data.users.find(x => x.username === u && x.password === p);
                    
                    if (user) {
                        System.currentUser = user;
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        this.postLoginInit();
                    } else {
                        alert('بيانات الدخول غير صحيحة');
                    }
                },
                logout: function() {
                    sessionStorage.removeItem('currentUser');
                    location.reload();
                },
                postLoginInit: function() {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    
                    document.getElementById('sidebar-username').innerText = System.currentUser.name;
                    document.getElementById('top-bar-user').innerText = System.currentUser.name;
                    document.getElementById('sidebar-initials').innerText = System.currentUser.name.charAt(0);
                    
                    const roleMap = { 'admin':'مدير النظام', 'manager':'مدير تعليمي', 'supervisor':'مشرف', 'coordinator':'منسق', 'teacher':'معلم' };
                    document.getElementById('sidebar-role').innerText = roleMap[System.currentUser.role];

                    System.ui.buildSidebar();
                    System.ui.updateNotificationCount();
                    
                    if(System.currentUser.role === 'admin') System.ui.showView('view-admin-structure');
                    else if(System.currentUser.role === 'coordinator') System.ui.showView('view-coordinator-entry');
                    else if(System.currentUser.role === 'teacher') System.ui.showView('view-notifications'); 
                    else System.ui.showView('view-dashboard');
                }
            },

            ui: {
                buildSidebar: function() {
                    const menu = document.getElementById('sidebar-menu'); menu.innerHTML = '';
                    const role = System.currentUser.role;
                    const addLink = (id, text, icon) => menu.innerHTML += `<a href="#" onclick="System.ui.showView('${id}')" id="link-${id}"><i class="fas ${icon} ms-2"></i>${text}</a>`;
                    if (role === 'admin') { addLink('view-admin-structure', 'الهيكل والإعدادات', 'fa-cogs'); addLink('view-users', 'المستخدمين', 'fa-users'); addLink('view-admin-assignments', 'تسكين المعلمين', 'fa-link'); }
                    if (['admin', 'manager', 'supervisor', 'coordinator'].includes(role)) { addLink('view-dashboard', 'حالة الرصد', 'fa-tachometer-alt'); addLink('view-procedures', 'الإجراءات', 'fa-gavel'); addLink('view-teacher-file', 'ملف المعلم', 'fa-id-card'); }
                    if (role === 'coordinator' || role === 'manager') { addLink('view-coordinator-entry', 'إدخال البنود', 'fa-edit'); }
                    if (role !== 'teacher') { addLink('view-reports', 'التقارير', 'fa-chart-bar'); }
                },
                
                showView: function(viewId) {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));
                    const target = document.getElementById(viewId); if(target) target.classList.remove('hidden');
                    const link = document.getElementById('link-' + viewId); if(link) link.classList.add('active');
                    const titles = {'view-admin-structure':'الإعدادات', 'view-users':'المستخدمين', 'view-admin-assignments':'تسكين المعلمين', 'view-coordinator-entry':'إدخال البيانات', 'view-dashboard':'لوحة التحكم', 'view-notifications':'الإشعارات', 'view-reports':'التقارير'};
                    document.getElementById('page-header-title').innerText = titles[viewId] || '';

                    if(viewId === 'view-admin-structure') System.admin.renderAllLists();
                    if(viewId === 'view-users') System.admin.initUserView();
                    if(viewId === 'view-admin-assignments') System.admin.initAssignmentsView(); 
                    if(viewId === 'view-coordinator-entry') System.coordinator.init();
                    if(viewId === 'view-dashboard') System.dashboard.init();
                    if(viewId === 'view-reports') System.reports.init();
                    if(viewId === 'view-notifications') System.notifications.render();
                    if(viewId === 'view-procedures') System.procedures.init();
                    if(viewId === 'view-teacher-file') System.teacherFile.init();
                },

                updateNotificationCount: function() { document.getElementById('nav-badge').innerText = System.data.notifications.length; document.getElementById('notif-count-display').innerText = System.data.notifications.length; },
                updateStagesDropdown: function(schoolSelectId = 'struct-school-select', stageSelectId = 'struct-stage-select') { const schoolId = parseInt(document.getElementById(schoolSelectId).value); const stageSelect = document.getElementById(stageSelectId); stageSelect.innerHTML = '<option value="">اختر المرحلة</option>'; const school = System.data.schools.find(s => s.id === schoolId); if(school && school.stages) school.stages.forEach(s => stageSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`); this.updateGradesDropdown(schoolSelectId, stageSelectId, 'struct-grade-select'); },
                updateGradesDropdown: function(schoolIdRef = 'struct-school-select', stageIdRef = 'struct-stage-select', targetId = 'struct-grade-select') { const schoolId = parseInt(document.getElementById(schoolIdRef).value); const stageId = document.getElementById(stageIdRef).value; const gradeSelect = document.getElementById(targetId); gradeSelect.innerHTML = '<option value="">اختر الصف</option>'; const school = System.data.schools.find(s => s.id === schoolId); if(school) { const stage = school.stages.find(s => s.id === stageId); if(stage && stage.grades) stage.grades.forEach(g => gradeSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`); } },
                toggleUserFields: function() { const role = document.getElementById('user-role').value; const fieldSub = document.getElementById('field-subject'); const scopeContainer = document.getElementById('scope-container'); if(['teacher', 'supervisor'].includes(role)) fieldSub.classList.remove('hidden'); else fieldSub.classList.add('hidden'); if(['coordinator', 'manager', 'teacher'].includes(role)) scopeContainer.classList.remove('hidden'); else scopeContainer.classList.add('hidden'); this.renderScopeOptions(); },
                renderScopeOptions: function() { const schoolId = parseInt(document.getElementById('user-school-select').value); const container = document.getElementById('scope-options'); container.innerHTML = ''; const school = System.data.schools.find(s => s.id === schoolId); if(!school || !school.stages) { container.innerHTML = '<small class="text-muted">الرجاء اختيار مدرسة صالحة</small>'; return; } school.stages.forEach(stage => { let html = `<div class="border p-2 rounded bg-light" style="min-width: 150px;"><strong class="d-block border-bottom mb-1 text-primary">${stage.name}</strong>`; if(stage.grades) stage.grades.forEach(g => { html += `<div class="form-check"><input class="form-check-input scope-check" type="checkbox" value="${stage.id}|${g.id}" id="sc_${g.id}"><label class="form-check-label small" for="sc_${g.id}">${g.name}</label></div>`; }); html += `</div>`; container.innerHTML += html; }); }
            },

            admin: {
                genId: () => '_' + Math.random().toString(36).substr(2, 9),
                renderAllLists: function() { this.renderList('schools', System.data.schools); this.renderList('subjects', System.data.subjects); this.renderList('weeks', System.data.weeks); this.renderList('criteria', System.data.criteria); const sel = document.getElementById('struct-school-select'); sel.innerHTML = '<option value="">اختر المدرسة</option>'; System.data.schools.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`); this.renderStructurePreview(); },
                renderList: function(type, dataArray) { const ul = document.getElementById(type + '-list'); ul.innerHTML = ''; if(dataArray && dataArray.length > 0){ dataArray.forEach(item => { ul.innerHTML += `<li class="list-group-item"><span>${item.name}</span><div><i class="fas fa-edit text-warning action-btn" onclick="System.admin.editItem('${type}', '${item.id}')"></i><i class="fas fa-trash text-danger action-btn" onclick="System.admin.deleteItem('${type}', '${item.id}')"></i></div></li>`; }); } },
                renderStructurePreview: function() { const container = document.getElementById('structure-preview'); container.innerHTML = ''; System.data.schools.forEach(s => { let html = `<div class="mb-2"><strong class="text-primary"><i class="fas fa-school"></i> ${s.name}</strong><ul class="mb-1">`; if(s.stages) s.stages.forEach(st => { html += `<li>${st.name} <ul>`; if(st.grades) st.grades.forEach(g => { html += `<li>${g.name} : `; if(g.classes) g.classes.forEach(c => { html += `<span class="badge bg-light text-dark border me-1">${c.name}</span>`; }); html += `</li>`; }); html += `</ul></li>`; }); html += `</ul></div>`; container.innerHTML += html; }); },
                addSchool: function() { const n = document.getElementById('new-school-name').value; if(n) { if(!System.data.schools) System.data.schools = []; System.data.schools.push({id: Date.now(), name: n, stages:[]}); System.save(); this.renderAllLists(); document.getElementById('new-school-name').value=''; } },
                addStage: function() { const sid = parseInt(document.getElementById('struct-school-select').value); const n = document.getElementById('new-stage-name').value; if(sid && n) { const school = System.data.schools.find(s => s.id === sid); if(school) { if(!school.stages) school.stages = []; school.stages.push({id: this.genId(), name: n, grades:[]}); System.save(); System.ui.updateStagesDropdown(); this.renderStructurePreview(); document.getElementById('new-stage-name').value = ''; } } else { alert('اختر المدرسة'); } },
                addGrade: function() { const sid = parseInt(document.getElementById('struct-school-select').value); const stid = document.getElementById('struct-stage-select').value; const n = document.getElementById('new-grade-name').value; if(sid && stid && n) { const school = System.data.schools.find(s => s.id === sid); if(school) { const stage = school.stages.find(s => s.id === stid); if(stage) { if(!stage.grades) stage.grades = []; stage.grades.push({id: this.genId(), name: n, classes:[]}); System.save(); System.ui.updateGradesDropdown(); this.renderStructurePreview(); document.getElementById('new-grade-name').value = ''; } } } else { alert('اختر المرحلة'); } },
                addClass: function() { const sid = parseInt(document.getElementById('struct-school-select').value); const stid = document.getElementById('struct-stage-select').value; const gid = document.getElementById('struct-grade-select').value; const n = document.getElementById('new-class-name').value; if(sid && stid && gid && n) { const school = System.data.schools.find(s => s.id === sid); if(school) { const stage = school.stages.find(s => s.id === stid); if(stage) { const grade = stage.grades.find(g => g.id === gid); if(grade) { if(!grade.classes) grade.classes = []; grade.classes.push({id: this.genId(), name: n}); System.save(); this.renderStructurePreview(); document.getElementById('new-class-name').value = ''; } } } } else { alert('اختر الصف'); } },
                addSubject: function() { const n = document.getElementById('new-subject-name').value; if(n) { if(!System.data.subjects) System.data.subjects = []; System.data.subjects.push({id: Date.now(), name: n}); System.save(); this.renderList('subjects', System.data.subjects); document.getElementById('new-subject-name').value=''; } },
                addWeek: function() { const n = document.getElementById('new-week-name').value; if(n) { if(!System.data.weeks) System.data.weeks = []; System.data.weeks.push({id: Date.now(), name: n}); System.save(); this.renderList('weeks', System.data.weeks); document.getElementById('new-week-name').value=''; } },
                addCriteria: function() { const n = document.getElementById('new-criteria-name').value; if(n) { if(!System.data.criteria) System.data.criteria = []; System.data.criteria.push({id: Date.now(), name: n}); System.save(); this.renderList('criteria', System.data.criteria); document.getElementById('new-criteria-name').value=''; } },
                editItem: function(type, id) { const isNum = type !== 'criteria' && type !== 'weeks' && type !== 'subjects'; const searchId = isNum ? parseInt(id) : id; const item = System.data[type].find(x => x.id == searchId); if(item) { const newName = prompt('تعديل:', item.name); if(newName && newName !== item.name) { item.name = newName; System.save(); this.renderAllLists(); } } },
                deleteItem: function(type, id) { if(confirm('حذف؟')) { if(type==='schools') id=parseInt(id); else id=isNaN(id)?id:parseInt(id); System.data[type] = System.data[type].filter(x => x.id !== id); System.save(); this.renderAllLists(); } },
                
                initUserView: function() { const schSel = document.getElementById('user-school-select'); schSel.innerHTML = '<option value="">اختر المدرسة</option>'; System.data.schools.forEach(s => schSel.innerHTML += `<option value="${s.id}">${s.name}</option>`); const subSel = document.getElementById('user-subject-select'); subSel.innerHTML = '<option value="">اختر المادة</option>'; System.data.subjects.forEach(s => subSel.innerHTML += `<option value="${s.id}">${s.name}</option>`); this.renderUsersTable(); },
                saveUser: function() {
                    const id = document.getElementById('user-edit-id').value; const name = document.getElementById('user-fullname').value; const username = document.getElementById('user-username').value; const mobile = document.getElementById('user-mobile').value; const password = document.getElementById('user-password').value; const role = document.getElementById('user-role').value; const schoolId = parseInt(document.getElementById('user-school-select').value); const subjectId = document.getElementById('user-subject-select').value;
                    if(!name || !username || !schoolId || !mobile) return alert('بيانات ناقصة');
                    const scope = { stageIds: [], gradeIds: [] }; document.querySelectorAll('.scope-check:checked').forEach(cb => { const [st, gr] = cb.value.split('|'); if(!scope.stageIds.includes(st)) scope.stageIds.push(st); scope.gradeIds.push(gr); });
                    const generatedPass = System.utils.generatePassword(); const finalPassword = password ? password : (id ? null : generatedPass);
                    const userObj = { id: id ? parseInt(id) : Date.now(), name, username, role, schoolId, mobile, subjectId: subjectId?parseInt(subjectId):null, scope };
                    if (finalPassword) userObj.password = finalPassword; else { const existing = System.data.users.find(u=>u.id==id); if(existing) userObj.password = existing.password; else userObj.password = generatedPass; }
                    if(id) { const idx = System.data.users.findIndex(u=>u.id==id); System.data.users[idx] = {...System.data.users[idx], ...userObj}; } else { System.data.users.push(userObj); }
                    System.save(); this.cancelEditUser(); this.renderUsersTable();
                },
                renderUsersTable: function() { const tbody = document.getElementById('users-table-body'); tbody.innerHTML = ''; System.data.users.forEach(u => { const sName = System.data.schools.find(s=>s.id === u.schoolId)?.name || '-'; tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.username}</td><td>${u.password}</td><td>${u.mobile||'-'}</td><td>${u.role}</td><td>${sName}</td><td><button class="btn btn-sm btn-warning" onclick="System.admin.loadUser(${u.id})"><i class="fas fa-pen"></i></button> <button class="btn btn-sm btn-danger" onclick="System.admin.delUser(${u.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); },
                loadUser: function(id) { const u = System.data.users.find(x => x.id === id); document.getElementById('user-edit-id').value = u.id; document.getElementById('user-fullname').value = u.name; document.getElementById('user-username').value = u.username; document.getElementById('user-password').value = u.password; document.getElementById('user-mobile').value = u.mobile || ''; document.getElementById('user-role').value = u.role; document.getElementById('user-school-select').value = u.schoolId; System.ui.toggleUserFields(); if(u.subjectId) document.getElementById('user-subject-select').value = u.subjectId; setTimeout(() => { if(u.scope && u.scope.gradeIds) u.scope.gradeIds.forEach(gid => { const cb = document.querySelector(`.scope-check[value*="${gid}"]`); if(cb) cb.checked = true; }); }, 100); document.getElementById('btn-save-user').innerText = 'تحديث'; document.getElementById('btn-cancel-user').classList.remove('hidden'); },
                cancelEditUser: function() { document.getElementById('user-edit-id').value = ''; document.getElementById('user-fullname').value = ''; document.getElementById('user-username').value = ''; document.getElementById('user-password').value = ''; document.getElementById('user-mobile').value = ''; document.getElementById('user-school-select').value = ''; document.getElementById('btn-save-user').innerText = 'حفظ'; document.getElementById('btn-cancel-user').classList.add('hidden'); document.getElementById('scope-options').innerHTML = ''; },
                delUser: function(id) { if(confirm('حذف؟')) { System.data.users = System.data.users.filter(u => u.id !== id); System.save(); this.renderUsersTable(); } },

                initAssignmentsView: function() { const schSel = document.getElementById('assign-school'); schSel.innerHTML = '<option value="">اختر المدرسة</option>'; System.data.schools.forEach(s => schSel.innerHTML += `<option value="${s.id}">${s.name}</option>`); const subSel = document.getElementById('assign-subject'); subSel.innerHTML = '<option value="">المادة الافتراضية</option>'; System.data.subjects.forEach(s => subSel.innerHTML += `<option value="${s.id}">${s.name}</option>`); this.renderCurrentAssignments(); },
                updateAssignStages: function() { System.ui.updateStagesDropdown('assign-school', 'assign-stage'); },
                updateAssignGrades: function() { System.ui.updateGradesDropdown('assign-school', 'assign-stage', 'assign-grade'); },
                updateAssignClasses: function() { const schoolId = parseInt(document.getElementById('assign-school').value); const gradeId = document.getElementById('assign-grade').value; const stageId = document.getElementById('assign-stage').value; const cSel = document.getElementById('assign-class'); const tSel = document.getElementById('assign-teacher'); cSel.innerHTML = ''; tSel.innerHTML = '<option value="">اختر المعلم</option>'; const school = System.data.schools.find(s => s.id === schoolId); if(school && stageId && gradeId) { const stage = school.stages.find(s => s.id === stageId); const grade = stage.grades.find(g => g.id === gradeId); if(grade && grade.classes) grade.classes.forEach(c => cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`); } System.data.users.filter(u => u.schoolId === schoolId && u.role === 'teacher').forEach(t => { tSel.innerHTML += `<option value="${t.id}">${t.name}</option>`; }); },
                saveAssignment: function() { const tId = parseInt(document.getElementById('assign-teacher').value); const cId = document.getElementById('assign-class').value; const subId = document.getElementById('assign-subject').value; if(!tId || !cId) return alert('البيانات ناقصة'); if(System.data.assignments.find(a => a.teacherId === tId && a.classId === cId)) return alert('مضاف مسبقاً'); const user = System.data.users.find(u => u.id === tId); const finalSubjectId = subId ? parseInt(subId) : user.subjectId; System.data.assignments.push({ id: Date.now(), teacherId: tId, classId: cId, subjectId: finalSubjectId }); System.save(); this.renderCurrentAssignments(); alert('تم الربط'); },
                renderCurrentAssignments: function() { const tbody = document.getElementById('assignments-table-body'); tbody.innerHTML = ''; System.data.assignments.forEach(a => { const t = System.data.users.find(u => u.id === a.teacherId); if(t) { const s = System.data.schools.find(school => school.id === t.schoolId); let stageName = '-', gradeName = '-', className = '-'; if(s) { s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === a.classId) { stageName = st.name; gradeName = g.name; className = c.name; } }))); } const subName = a.subjectId ? (System.data.subjects.find(sub=>sub.id == a.subjectId)?.name || 'غير محدد') : 'غير محدد'; tbody.innerHTML += `<tr><td>${s ? s.name : '-'}</td><td>${stageName} - ${gradeName}</td><td>${className}</td><td class="fw-bold text-primary">${t.name}</td><td>${subName}</td><td><button class="btn btn-sm btn-danger" onclick="System.admin.delAssignment(${a.id})"><i class="fas fa-trash"></i></button></td></tr>`; } }); },
                delAssignment: function(id) { if(confirm('إلغاء التسكين؟')) { System.data.assignments = System.data.assignments.filter(a => a.id !== id); System.save(); this.renderCurrentAssignments(); } }
            },

            coordinator: {
                init: function() { const user = System.currentUser; const school = System.data.schools.find(s => s.id === user.schoolId); if(!school) return; const stageSel = document.getElementById('entry-stage'); stageSel.innerHTML = '<option value="">اختر المرحلة</option>'; const stagesToShow = (user.scope && user.scope.stageIds && user.scope.stageIds.length > 0) ? school.stages.filter(s => user.scope.stageIds.includes(s.id)) : school.stages; if(stagesToShow) stagesToShow.forEach(s => stageSel.innerHTML += `<option value="${s.id}">${s.name}</option>`); const wSel = document.getElementById('entry-week'); wSel.innerHTML = ''; System.data.weeks.forEach(w => wSel.innerHTML += `<option value="${w.id}">${w.name}</option>`); document.getElementById('entry-date').valueAsDate = new Date(); document.getElementById('matrix-container').classList.add('hidden'); },
                updateEntryGrades: function() { const schoolId = System.currentUser.schoolId; const stageId = document.getElementById('entry-stage').value; const gradeSelect = document.getElementById('entry-grade'); gradeSelect.innerHTML = '<option value="">اختر الصف</option>'; document.getElementById('entry-class').innerHTML = '<option value="">اختر الفصل</option>'; document.getElementById('entry-teacher').innerHTML = ''; const school = System.data.schools.find(s => s.id === schoolId); if(school) { const stage = school.stages.find(s => s.id === stageId); if(stage && stage.grades) { const userScope = System.currentUser.scope; const gradesToShow = (userScope && userScope.gradeIds && userScope.gradeIds.length > 0) ? stage.grades.filter(g => userScope.gradeIds.includes(g.id)) : stage.grades; gradesToShow.forEach(g => gradeSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`); } } document.getElementById('matrix-container').classList.add('hidden'); },
                updateEntryClasses: function() { const schoolId = System.currentUser.schoolId; const stageId = document.getElementById('entry-stage').value; const gradeId = document.getElementById('entry-grade').value; const cSel = document.getElementById('entry-class'); cSel.innerHTML = '<option value="">اختر الفصل</option>'; document.getElementById('entry-teacher').innerHTML = ''; const school = System.data.schools.find(s => s.id === schoolId); if(school && stageId && gradeId) { const stage = school.stages.find(s => s.id === stageId); const grade = stage.grades.find(g => g.id === gradeId); if(grade && grade.classes) grade.classes.forEach(c => cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`); } document.getElementById('matrix-container').classList.add('hidden'); },
                updateEntryTeachers: function() { const classId = document.getElementById('entry-class').value; const tSel = document.getElementById('entry-teacher'); tSel.innerHTML = '<option value="">اختر المعلم</option>'; document.getElementById('entry-subject').innerHTML = ''; if(!classId) return; const assigns = System.data.assignments.filter(a => a.classId === classId); assigns.forEach(a => { const t = System.data.users.find(u => u.id === a.teacherId); if(t) tSel.innerHTML += `<option value="${t.id}">${t.name}</option>`; }); },
                updateEntrySubjects: function() { const tId = parseInt(document.getElementById('entry-teacher').value); const classId = document.getElementById('entry-class').value; const sSel = document.getElementById('entry-subject'); sSel.innerHTML = ''; if(!tId || !classId) return; const assign = System.data.assignments.find(a => a.teacherId === tId && a.classId === classId); if(assign && assign.subjectId) { const sub = System.data.subjects.find(s => s.id === assign.subjectId); if(sub) sSel.innerHTML = `<option value="${sub.id}">${sub.name}</option>`; } else { sSel.innerHTML = '<option value="">غير محدد</option>'; } },
                loadMatrix: function() { const classId = document.getElementById('entry-class').value; const weekId = parseInt(document.getElementById('entry-week').value); const dateVal = document.getElementById('entry-date').value; const teacherId = parseInt(document.getElementById('entry-teacher').value); if(!classId || !weekId || !teacherId || !dateVal) return alert('الرجاء إكمال جميع الحقول'); let className = ""; System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === classId) className = `${s.name} - ${st.name} - ${g.name} - ${c.name}`; })))); const weekName = System.data.weeks.find(w => w.id === weekId)?.name; document.getElementById('matrix-title').innerHTML = `تقييم ${className} | ${weekName} <br> <span class="text-dark small">${dateVal}</span>`; const assignments = System.data.assignments.filter(a => a.classId === classId && a.teacherId === teacherId); const table = document.querySelector('#matrix-table'); if(assignments.length === 0) { table.querySelector('thead').innerHTML = ''; table.querySelector('tbody').innerHTML = '<tr><td colspan="100" class="text-center p-3 text-danger">لا يوجد تسكين.</td></tr>'; document.getElementById('matrix-container').classList.remove('hidden'); document.getElementById('btn-save-matrix').classList.add('hidden'); return; } let thead = `<tr><th style="width:30%">المعيار</th>`; const teachers = []; assignments.forEach(a => { const t = System.data.users.find(u => u.id === a.teacherId); const subName = System.data.subjects.find(s => s.id === a.subjectId)?.name || ''; teachers.push({t, subName}); thead += `<th>${t.name}<br><small class="text-secondary">${subName}</small></th>`; }); thead += `</tr>`; table.querySelector('thead').innerHTML = thead; let tbody = ''; System.data.criteria.forEach(crit => { tbody += `<tr><td>${crit.name}</td>`; teachers.forEach(item => { const existing = System.data.evaluations.find(e => e.weekId === weekId && e.classId === classId && e.teacherId === item.t.id && e.criteriaId === crit.id); tbody += `<td><input type="checkbox" class="checkbox-cell" data-tid="${item.t.id}" data-cid="${crit.id}" ${existing ? 'checked' : ''}></td>`; }); tbody += `</tr>`; }); tbody += `<tr><td class="bg-light fw-bold">ملاحظات</td>`; teachers.forEach(item => { const existing = System.data.evaluations.find(e => e.weekId === weekId && e.classId === classId && e.teacherId === item.t.id); const noteText = existing ? (existing.notes || '') : ''; tbody += `<td><textarea class="form-control teacher-note" data-tid="${item.t.id}" rows="2" placeholder="ملاحظات...">${noteText}</textarea></td>`; }); tbody += `</tr>`; table.querySelector('tbody').innerHTML = tbody; document.getElementById('matrix-container').classList.remove('hidden'); document.getElementById('btn-save-matrix').classList.remove('hidden'); },
                saveMatrix: function() { const classId = document.getElementById('entry-class').value; const weekId = parseInt(document.getElementById('entry-week').value); const date = document.getElementById('entry-date').value; const tids = [...new Set(Array.from(document.querySelectorAll('.checkbox-cell')).map(c => parseInt(c.dataset.tid)))]; System.data.evaluations = System.data.evaluations.filter(e => !(e.weekId === weekId && e.classId === classId && tids.includes(e.teacherId))); document.querySelectorAll('.checkbox-cell:checked').forEach(cb => { const tid = parseInt(cb.dataset.tid); const cid = isNaN(cb.dataset.cid) ? cb.dataset.cid : parseInt(cb.dataset.cid); const note = document.querySelector(`.teacher-note[data-tid="${tid}"]`)?.value || ''; System.data.evaluations.push({ weekId, classId, teacherId: tid, criteriaId: cid, value: 1, date, notes: note }); }); System.save(); alert('تم حفظ التقييم'); }
            },

            dashboard: {
                init: function() { const wSel = document.getElementById('dash-week'); wSel.innerHTML = ''; System.data.weeks.forEach(w => wSel.innerHTML += `<option value="${w.id}">${w.name}</option>`); this.renderStats(); this.renderMonitoringStatus(); this.updateStatsFilters('all'); },
                renderStats: function() { const container = document.getElementById('general-stats-row'); const createCard = (title, val, color, icon) => `<div class="col-md-3"><div class="stat-card bg-${color}"><h3>${val}</h3><p>${title}</p><i class="fas ${icon}"></i></div></div>`; let html = ''; if (System.currentUser.role === 'admin') { html += createCard('المدارس', System.data.schools.length, 'primary', 'fa-school'); html += createCard('المستخدمين', System.data.users.length, 'success', 'fa-users'); } html += createCard('التسكينات', System.data.assignments.length, 'warning', 'fa-link'); html += createCard('الإشعارات', System.data.notifications.length, 'danger', 'fa-bell'); container.innerHTML = html; },
                renderMonitoringStatus: function() { const weekId = parseInt(document.getElementById('dash-week').value); const weekName = System.data.weeks.find(w => w.id === weekId)?.name || '-'; const tbody = document.querySelector('#monitoring-table tbody'); tbody.innerHTML = ''; const criteriaCount = System.data.criteria.length; let incompleteCount = 0; System.data.assignments.forEach(assign => { const teacher = System.data.users.find(u => u.id === assign.teacherId); if(!teacher) return; const viewer = System.currentUser; if(viewer.role !== 'admin' && teacher.schoolId !== viewer.schoolId) return; if(viewer.role === 'coordinator' && (!viewer.scope?.gradeIds?.includes(this.getGradeId(assign.classId)))) return; const evals = System.data.evaluations.filter(e => e.weekId === weekId && e.classId === assign.classId && e.teacherId === teacher.id); const missingCount = criteriaCount - evals.length; if(missingCount > 0) { incompleteCount++; let stageName='', className='', gradeId=''; System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === assign.classId) { stageName = st.name; className = `${g.name} - ${c.name}`; gradeId=g.id; } })))); const coord = System.data.users.find(u => u.role === 'coordinator' && u.schoolId === teacher.schoolId && u.scope?.gradeIds?.includes(gradeId)); const coordName = coord ? coord.name : '<span class="text-muted text-small">غير محدد</span>'; const missingIds = System.data.criteria.map(c => c.id).filter(cid => !evals.find(e => e.criteriaId === cid)); const missingNames = missingIds.map(id => System.data.criteria.find(c => c.id === id).name); const subjectName = System.data.subjects.find(s => s.id === assign.subjectId)?.name || 'غير محدد'; const msg = `أثناء زيارة فصل ${className} (مادة ${subjectName}) وجدت هذه البنود غير مفعلة (${missingNames.join('، ')}) ...`; tbody.innerHTML += `<tr><td>${stageName}</td><td>${className}</td><td>${weekName}</td><td>${subjectName}</td><td>${teacher.name}</td><td>${coordName}</td><td class="text-danger fw-bold cursor-pointer" onclick="System.dashboard.showMissingDetails('${missingNames.join(',')}')">${missingCount}</td><td><button class="btn btn-sm btn-success" onclick="System.utils.sendWhatsapp('${teacher.mobile}', '${teacher.id}', \`${msg}\`, '${missingNames.join(' - ')}')">مراسلة</button></td></tr>`; } }); if(incompleteCount === 0) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-success">جميع الفصول مكتملة الرصد لهذا الأسبوع</td></tr>'; },
                getGradeId: function(classId) { let gid = null; System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === classId) gid = g.id; })))); return gid; },
                showMissingDetails: function(itemsString) { const items = itemsString.split(','); document.getElementById('missing-items-content').innerHTML = `<ul class="list-group">${items.map(i => `<li class="list-group-item list-group-item-danger">${i}</li>`).join('')}</ul>`; new bootstrap.Modal(document.getElementById('missingItemsModal')).show(); },
                updateStatsFilters: function(level) { const schoolSel = document.getElementById('stats-school'); const gradeSel = document.getElementById('stats-grade'); const classSel = document.getElementById('stats-class'); if (level === 'all') { schoolSel.innerHTML = '<option value="all">الجميع</option>'; System.data.schools.forEach(s => schoolSel.innerHTML += `<option value="${s.id}">${s.name}</option>`); } if (level === 'school' || level === 'all') { gradeSel.innerHTML = '<option value="all">الجميع</option>'; const sid = schoolSel.value; if (sid !== 'all') { System.data.schools.find(s => s.id == sid)?.stages.forEach(st => st.grades.forEach(g => gradeSel.innerHTML += `<option value="${g.id}">${g.name}</option>`)); } } if (level === 'grade' || level === 'all') { classSel.innerHTML = '<option value="all">الجميع</option>'; const sid = schoolSel.value; const gid = gradeSel.value; if (sid !== 'all' && gid !== 'all') { let targetGrade = null; System.data.schools.find(s=>s.id == sid)?.stages.forEach(st => { const found = st.grades.find(g => g.id == gid); if(found) targetGrade = found; }); if (targetGrade) targetGrade.classes.forEach(c => classSel.innerHTML += `<option value="${c.id}">${c.name}</option>`); } } },
                renderCriteriaStats: function() { const schoolId = document.getElementById('stats-school').value; const gradeId = document.getElementById('stats-grade').value; const classId = document.getElementById('stats-class').value; const isCoord = System.currentUser.role === 'coordinator'; const userSchoolId = System.currentUser.schoolId; const allowedGrades = System.currentUser.scope?.gradeIds || []; let filteredAssignments = System.data.assignments.filter(a => { const teacher = System.data.users.find(u => u.id === a.teacherId); if (!teacher) return false; if(isCoord) { if(teacher.schoolId !== userSchoolId) return false; const actualGradeId = System.dashboard.getGradeId(a.classId); if(!allowedGrades.includes(actualGradeId)) return false; } if (schoolId !== 'all' && teacher.schoolId != schoolId) return false; let foundGid = null; System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => { if (g.classes.find(c => c.id === a.classId)) foundGid = g.id; }))); if (gradeId !== 'all' && foundGid != gradeId) return false; if (classId !== 'all' && a.classId != classId) return false; return true; }); const relevantEvals = System.data.evaluations.filter(e => filteredAssignments.find(a => a.teacherId === e.teacherId && a.classId === e.classId)); const uniqueVisits = new Set(relevantEvals.map(e => `${e.weekId}_${e.classId}_${e.teacherId}`)).size; const tbody = document.querySelector('#criteria-stats-table tbody'); tbody.innerHTML = ''; if (uniqueVisits === 0) { tbody.innerHTML = '<tr><td colspan="4">لا توجد بيانات</td></tr>'; return; } System.data.criteria.forEach(crit => { const actualCount = relevantEvals.filter(e => e.criteriaId === crit.id).length; const percent = Math.round((actualCount / uniqueVisits) * 100); let color = percent < 50 ? 'danger' : (percent < 80 ? 'warning' : 'success'); tbody.innerHTML += `<tr><td>${crit.name}</td><td>${actualCount}</td><td>${uniqueVisits}</td><td><div class="progress position-relative" style="height: 25px;"><div class="progress-bar bg-${color}" role="progressbar" style="width: ${percent}%"></div><span class="position-absolute w-100 text-center text-dark fw-bold" style="top: 2px;">${percent}%</span></div></td></tr>`; }); }
            },

            utils: {
                generatePassword: function() { return Math.random().toString(36).slice(-8); },
                sendWhatsapp: function(mobile, teacherId, msg, missingItemsStr) { if(!mobile) return; const today = new Date(); System.data.notifications.push({ id: Date.now(), teacherId: parseInt(teacherId), type: 'whatsapp_alert', date: today.toISOString().split('T')[0], day: '-', details: msg, missing: missingItemsStr }); System.save(); System.ui.updateNotificationCount(); window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, '_blank'); },
                printAllNotifications: function() { if(System.data.notifications.length === 0) return alert('لا توجد إشعارات'); let html = `<div style="direction: rtl; text-align: right; padding: 20px;"><h2 style="text-align: center;">سجل الإشعارات</h2><table style="width: 100%; border-collapse: collapse; border: 1px solid #000;"><thead><tr style="background: #f0f0f0;"><th style="border: 1px solid #000; padding: 8px;">التاريخ</th><th style="border: 1px solid #000; padding: 8px;">المعلم</th><th style="border: 1px solid #000; padding: 8px;">التفاصيل</th></tr></thead><tbody>`; [...System.data.notifications].reverse().forEach(n => { const t = System.data.users.find(u => u.id === n.teacherId)?.name || 'غير معروف'; const fullText = n.details + (n.missing ? `<br><small><b>النواقص:</b> ${n.missing}</small>` : ''); html += `<tr><td style="border: 1px solid #000; padding: 8px;">${n.date}</td><td style="border: 1px solid #000; padding: 8px;">${t}</td><td style="border: 1px solid #000; padding: 8px;">${fullText}</td></tr>`; }); html += `</tbody></table></div>`; document.getElementById('print-area-container').innerHTML = html; document.body.classList.add('printing-notification'); window.print(); document.body.classList.remove('printing-notification'); },
                getSubjectName: function(id) { return System.data.subjects.find(s=>s.id == id)?.name || ''; }
            },

            notifications: { render: function() { const list = document.getElementById('notif-list'); list.innerHTML = ''; [...System.data.notifications].reverse().forEach(n => { const t = System.data.users.find(u => u.id === n.teacherId)?.name || 'غير معروف'; const fullMessage = n.details + (n.missing ? `<br><span class="text-danger small"><strong>النواقص:</strong> ${n.missing}</span>` : ''); list.innerHTML += `<li class="list-group-item d-block"><div class="d-flex justify-content-between"><strong>${t}</strong><small class="text-muted">${n.date}</small></div><div class="mt-2" style="white-space: pre-wrap;">${fullMessage}</div></li>`; }); } },
            procedures: { init: function() { const tSel = document.getElementById('proc-teacher'); tSel.innerHTML = ''; System.data.users.filter(u => u.role === 'teacher').forEach(t => tSel.innerHTML += `<option value="${t.id}">${t.name}</option>`); this.renderList(); }, add: function() { const tid = parseInt(document.getElementById('proc-teacher').value); const type = document.getElementById('proc-type').value; const date = document.getElementById('proc-date').value; const situation = document.getElementById('proc-situation').value; const action = document.getElementById('proc-action').value; if(tid && date) { System.data.procedures.push({id:Date.now(), teacherId:tid, type, date, situation, action}); System.save(); alert('تم الحفظ'); this.renderList(); } }, renderList: function() { const tbody = document.querySelector('#procedures-table tbody'); tbody.innerHTML = ''; System.data.procedures.forEach(p => { const t = System.data.users.find(u => u.id === p.teacherId)?.name || '-'; tbody.innerHTML += `<tr><td>${t}</td><td>${p.type}</td><td>${p.date}</td><td>${p.situation}</td><td>${p.action}</td></tr>`; }); } },
            
            teacherFile: { 
                init: function() { const sel = document.getElementById('file-teacher-select'); sel.innerHTML = '<option value="">اختر...</option>'; const isCoord = System.currentUser.role === 'coordinator'; const mySchool = System.currentUser.schoolId; System.data.users.filter(u => u.role === 'teacher').forEach(t => { if(!isCoord || (isCoord && t.schoolId === mySchool)) { sel.innerHTML += `<option value="${t.id}">${t.name}</option>`; } }); }, 
                render: function() { 
                    const tid = parseInt(document.getElementById('file-teacher-select').value); if(!tid) return document.getElementById('teacher-file-content').classList.add('hidden'); document.getElementById('teacher-file-content').classList.remove('hidden'); const t = System.data.users.find(u => u.id === tid); const schoolName = System.data.schools.find(s=>s.id === t.schoolId)?.name || '-'; document.getElementById('tf-name').innerText = t.name; document.getElementById('tf-school').innerText = schoolName; const praise = System.data.procedures.filter(p => p.teacherId === tid && p.type === 'praise'); const violations = System.data.procedures.filter(p => p.teacherId === tid && p.type !== 'praise'); const gapsTable = document.querySelector('#table-gaps tbody'); gapsTable.innerHTML = ''; let gapVisitsCount = 0; const distinctVisits = []; System.data.evaluations.filter(e => e.teacherId === tid).forEach(e => { const key = `${e.weekId}_${e.classId}`; if(!distinctVisits.includes(key)) distinctVisits.push(key); }); distinctVisits.forEach(key => { const [wid, cid] = key.split('_'); const weekName = System.data.weeks.find(w => w.id == wid)?.name || '-'; const evals = System.data.evaluations.filter(e => e.teacherId === tid && e.weekId == wid && e.classId == cid); if(evals.length > 0) { const date = evals[0].date; let className = ''; System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === cid) className = `${c.name}`; })))); const assign = System.data.assignments.find(a => a.teacherId === tid && a.classId === cid); const subName = assign ? System.utils.getSubjectName(assign.subjectId) : '-'; const presentIds = evals.map(e => e.criteriaId); const missingCriteria = System.data.criteria.filter(c => !presentIds.includes(c.id)); const missingNames = missingCriteria.map(c => c.name); const missingCount = missingCriteria.length; if(missingCount > 0) { gapVisitsCount++; const performance = Math.round((presentIds.length / System.data.criteria.length) * 100); gapsTable.innerHTML += `<tr><td>${className}</td><td>${weekName}</td><td>${subName}</td><td>${date}</td><td class="text-danger fw-bold text-center">${missingCount}</td><td class="small text-muted">${missingNames.join(' ، ')}</td><td><span class="badge bg-${performance < 50 ? 'danger' : 'warning'}">${performance}%</span></td></tr>`; } } }); 
                    document.getElementById('tf-praise-count').innerText = praise.length; document.getElementById('tf-violation-count').innerText = violations.length; document.getElementById('tf-gaps-count').innerText = gapVisitsCount;
                    const tablePraise = document.querySelector('#table-praise tbody'); tablePraise.innerHTML = ''; praise.forEach(p => tablePraise.innerHTML += `<tr><td>-</td><td>${p.date}</td><td>${p.type}</td><td>${p.situation}</td><td>${p.action}</td></tr>`); const tableViol = document.querySelector('#table-violations tbody'); tableViol.innerHTML = ''; violations.forEach(p => tableViol.innerHTML += `<tr><td>${p.type}</td><td>${p.date}</td><td>${p.situation}</td><td>${p.action}</td></tr>`); 
                } 
            },

            reports: { 
                init: function() { const wSel = document.getElementById('rep-week'); wSel.innerHTML = '<option value="all">كل الأسابيع</option>'; System.data.weeks.forEach(w => wSel.innerHTML += `<option value="${w.id}">${w.name}</option>`); this.generate(); }, 
                generate: function() { const weekIdFilter = document.getElementById('rep-week').value; const isCoord = System.currentUser.role === 'coordinator'; const userSchoolId = System.currentUser.schoolId; const allowedGrades = System.currentUser.scope?.gradeIds || []; let filteredEvals = System.data.evaluations.filter(e => { const teacher = System.data.users.find(u => u.id === e.teacherId); if(!teacher) return false; if(isCoord) { if(teacher.schoolId !== userSchoolId) return false; const gid = System.dashboard.getGradeId(e.classId); if(!allowedGrades.includes(gid)) return false; } if(weekIdFilter !== 'all' && e.weekId != weekIdFilter) return false; return true; }); const criteriaStats = {}; System.data.criteria.forEach(c => criteriaStats[c.name] = 0); filteredEvals.forEach(e => { const cName = System.data.criteria.find(c => c.id === e.criteriaId)?.name; if(cName) criteriaStats[cName]++; }); this.renderPieChart(criteriaStats); this.renderBarChart(filteredEvals); this.renderPerformanceTable(filteredEvals); this.renderDetailedTable(filteredEvals); },
                renderPieChart: function(data) { const ctx = document.getElementById('chart-pie').getContext('2d'); if(System.charts.pie) System.charts.pie.destroy(); System.charts.pie = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545'] }] } }); },
                renderBarChart: function(evals) { const scores = {}; evals.forEach(e => { if(!scores[e.teacherId]) scores[e.teacherId] = 0; scores[e.teacherId]++; }); const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]).slice(0, 5); const labels = sorted.map(i => System.data.users.find(u => u.id == i[0])?.name); const values = sorted.map(i => i[1]); const ctx = document.getElementById('chart-bar').getContext('2d'); if(System.charts.bar) System.charts.bar.destroy(); System.charts.bar = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'نقاط التفعيل', data: values, backgroundColor: '#0d6efd' }] } }); },
                renderPerformanceTable: function(evals) { const tbody = document.querySelector('#report-table tbody'); tbody.innerHTML = ''; const teacherStats = {}; evals.forEach(e => { if(!teacherStats[e.teacherId]) teacherStats[e.teacherId] = { count: 0, classes: new Set() }; teacherStats[e.teacherId].count++; teacherStats[e.teacherId].classes.add(e.classId + '_' + e.weekId); }); Object.keys(teacherStats).forEach(tid => { const t = System.data.users.find(u => u.id == tid); if(t) { const sub = System.data.subjects.find(s => s.id === t.subjectId)?.name || '-'; const totalCriteriaPossibility = teacherStats[tid].classes.size * System.data.criteria.length; const percent = totalCriteriaPossibility > 0 ? Math.round((teacherStats[tid].count / totalCriteriaPossibility) * 100) : 0; tbody.innerHTML += `<tr><td>${t.name}</td><td>${sub}</td><td>${teacherStats[tid].classes.size}</td><td>${teacherStats[tid].count}</td><td>${percent}%</td></tr>`; } }); },
                renderDetailedTable: function(evals) { const tbody = document.querySelector('#detailed-data-table tbody'); tbody.innerHTML = ''; const visits = {}; evals.forEach(e => { const key = `${e.weekId}_${e.classId}_${e.teacherId}`; if(!visits[key]) { visits[key] = { date: e.date, teacherId: e.teacherId, classId: e.classId, weekId: e.weekId, criteriaIds: [] }; } visits[key].criteriaIds.push(e.criteriaId); }); Object.values(visits).forEach(v => { const t = System.data.users.find(u => u.id == v.teacherId)?.name; let className = ''; System.data.schools.forEach(s => s.stages.forEach(st => s.grades?.forEach(g => g.classes?.forEach(c => { if(c.id === v.classId) className = c.name; })))); const assign = System.data.assignments.find(a => a.teacherId == v.teacherId && a.classId == v.classId); const subName = assign ? System.utils.getSubjectName(assign.subjectId) : '-'; const activeNames = v.criteriaIds.map(cid => System.data.criteria.find(c => c.id === cid)?.name).filter(Boolean).join('، '); const allCriteriaIds = System.data.criteria.map(c => c.id); const missingIds = allCriteriaIds.filter(id => !v.criteriaIds.includes(id)); const missingNames = missingIds.map(id => System.data.criteria.find(c => c.id === id)?.name).filter(Boolean).join('، '); tbody.innerHTML += `<tr><td>${v.date}</td><td>${t}</td><td>${subName}</td><td>${className}</td><td class="text-success small">${activeNames}</td><td class="text-danger small">${missingNames}</td></tr>`; }); }
            }
        };

        // Make System Global for HTML onClick handlers
        window.System = System;
        
        // Start
        window.onload = function() { System.init(); };
    </script>
</body>
</html>
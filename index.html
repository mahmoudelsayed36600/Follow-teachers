<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة المعلمين الشامل - النسخة المتكاملة V4.6 (Fix)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f6f9; overflow-x: hidden; }
        
        /* Sidebar Styling */
        .sidebar {
            height: 100vh;
            width: 260px;
            position: fixed;
            top: 0;
            right: 0;
            background-color: #212529;
            padding-top: 20px;
            color: white;
            transition: 0.3s;
            z-index: 1000;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .sidebar a {
            padding: 12px 20px;
            text-decoration: none;
            font-size: 14px;
            color: #adb5bd;
            display: block;
            transition: 0.2s;
            border-right: 3px solid transparent;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #343a40;
            color: #fff;
            border-right-color: #0d6efd;
        }
        .sidebar .user-info {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #343a40;
            margin-bottom: 20px;
        }

        /* Content Styling */
        .main-content {
            margin-right: 260px;
            padding: 30px;
            transition: 0.3s;
        }
        
        /* Login Page */
        #login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #0d6efd, #6610f2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        /* Cards */
        .section-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        
        /* Stat Cards */
        .stat-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .stat-card h3 { font-weight: bold; margin: 0; }
        .stat-card p { margin: 0; opacity: 0.8; }
        .stat-card i { position: absolute; left: 10px; bottom: 10px; opacity: 0.2; font-size: 3rem; }

        /* Matrix Table */
        .matrix-table th, .matrix-table td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }
        .matrix-table thead {
            background-color: #f8f9fa;
        }
        .checkbox-cell {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Notifications */
        .notification-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 0.7rem;
        }
        
        /* Utility */
        .hidden { display: none !important; }
        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-btn {
            cursor: pointer;
            margin-left: 5px;
            opacity: 0.7;
            transition: 0.2s;
        }
        .action-btn:hover { opacity: 1; transform: scale(1.1); }
        .cursor-pointer { cursor: pointer; }
        
        /* Reports Tabs */
        .nav-tabs .nav-link { color: #495057; cursor: pointer; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; background-color: #fff; border-bottom-color: transparent; }

        /* Custom Progress */
        .progress-thin { height: 10px; border-radius: 5px; }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* Print Styling */
        @media print {
            .sidebar, .no-print, #login-section, .btn, .modal { display: none !important; }
            .main-content { margin-right: 0; padding: 0; width: 100%; }
            .section-card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; }
            body { background-color: white; font-size: 12pt; }
            
            /* Print Specific Area Logic */
            body.printing-notification * { visibility: hidden; }
            body.printing-notification #print-area-container, body.printing-notification #print-area-container * { visibility: visible; }
            body.printing-notification #print-area-container { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 fw-bold text-primary">جاري الاتصال بقاعدة البيانات...</p>
    </div>

    <div class="modal fade" id="missingItemsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle ms-2"></i>البنود غير المرصودة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="missing-items-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="print-area-container" class="d-none"></div>

    <div id="login-section" class="hidden"> <div class="login-card text-center">
            <div class="mb-4">
                <i class="fas fa-school fa-3x text-primary"></i>
            </div>
            <h4 class="mb-4 fw-bold">بوابة المتابعة التعليمية</h4>
            <div class="mb-3 text-end">
                <label class="form-label text-muted small">اسم المستخدم</label>
                <input type="text" id="login-username" class="form-control" placeholder="">
            </div>
            <div class="mb-4 text-end">
                <label class="form-label text-muted small">كلمة المرور</label>
                <input type="password" id="login-password" class="form-control" placeholder="">
            </div>
            <button onclick="System.auth.login()" class="btn btn-primary w-100 py-2 fw-bold">تسجيل الدخول</button>
            </div>
    </div>

    <div id="sidebar" class="sidebar hidden">
        <div class="user-info">
            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                <span class="text-white h3 m-0" id="sidebar-initials">A</span>
            </div>
            <h5 id="sidebar-username" class="mb-0">المستخدم</h5>
            <small id="sidebar-role" class="text-muted">الدور</small>
        </div>
        
        <a href="#" onclick="System.ui.showView('view-notifications')" class="position-relative">
            <i class="fas fa-bell ms-2"></i> الإشعارات
            <span id="nav-badge" class="badge bg-danger rounded-pill position-absolute" style="left: 10px; top: 10px;">0</span>
        </a>
        <hr class="border-secondary my-1">
        
        <div id="sidebar-menu"></div>
        
        <div class="mt-auto pt-4 px-3 border-top border-secondary">
            <a href="#" onclick="System.auth.logout()" class="text-danger fw-bold"><i class="fas fa-sign-out-alt ms-2"></i>تسجيل خروج</a>
        </div>
    </div>

    <div id="main-content" class="main-content hidden">
        
        <div class="d-flex justify-content-between align-items-center mb-3 no-print">
            <h4 class="text-secondary" id="page-header-title"></h4>
            <div>
                 <span class="badge bg-light text-dark border me-2"><i class="fas fa-user ms-1"></i> <span id="top-bar-user"></span></span>
                <button onclick="window.print()" class="btn btn-secondary btn-sm"><i class="fas fa-print ms-2"></i>طباعة</button>
            </div>
        </div>

        <div id="view-admin-structure" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-cogs ms-2"></i>تهيئة الهيكل والمحتوى</h3>
            <div class="row">
                <div class="col-lg-6">
                    <div class="section-card">
                        <h5 class="border-bottom pb-2 mb-3">1. الهيكل الإداري</h5>
                        <div class="mb-3">
                            <label class="form-label small text-muted">إضافة مدرسة جديدة</label>
                            <div class="input-group">
                                <input type="text" id="new-school-name" class="form-control" placeholder="اسم المدرسة">
                                <button onclick="System.admin.addSchool()" class="btn btn-success"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <ul id="schools-list" class="list-group mb-4"></ul>

                        <div class="bg-light p-3 rounded">
                            <label class="form-label small fw-bold">إضافة مراحل وصفوف:</label>
                            <select id="struct-school-select" class="form-select mb-2" onchange="System.ui.updateStagesDropdown()"></select>
                            
                            <div class="input-group mb-2">
                                <input type="text" id="new-stage-name" class="form-control" placeholder="المرحلة (مثلاً: ابتدائية)">
                                <button onclick="System.admin.addStage()" class="btn btn-primary btn-sm">إضافة مرحلة</button>
                            </div>
                            
                            <div class="input-group mb-2">
                                <select id="struct-stage-select" class="form-select" onchange="System.ui.updateGradesDropdown()"></select>
                                <input type="text" id="new-grade-name" class="form-control" placeholder="الصف (مثلاً: الأول)">
                                <button onclick="System.admin.addGrade()" class="btn btn-secondary btn-sm">إضافة صف</button>
                            </div>

                            <div class="input-group">
                                <select id="struct-grade-select" class="form-select"></select>
                                <input type="text" id="new-class-name" class="form-control" placeholder="الفصل (مثلاً: 1/1)">
                                <button onclick="System.admin.addClass()" class="btn btn-info text-white btn-sm">إضافة فصل</button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6 class="small text-muted">معاينة الهيكل:</h6>
                            <div id="structure-preview" class="border p-2 bg-white rounded" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="section-card">
                        <h5 class="border-bottom pb-2 mb-3">2. المحتوى والبنود</h5>
                        <div class="mb-3">
                            <label class="form-label small text-muted">المواد الدراسية</label>
                            <div class="input-group mb-2">
                                <input type="text" id="new-subject-name" class="form-control" placeholder="اسم المادة">
                                <button onclick="System.admin.addSubject()" class="btn btn-success"><i class="fas fa-plus"></i></button>
                            </div>
                            <ul id="subjects-list" class="list-group" style="max-height: 150px; overflow-y: auto;"></ul>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">الأسابيع الدراسية</label>
                            <div class="input-group mb-2">
                                <input type="text" id="new-week-name" class="form-control" placeholder="الأسبوع الأول">
                                <button onclick="System.admin.addWeek()" class="btn btn-success"><i class="fas fa-plus"></i></button>
                            </div>
                            <ul id="weeks-list" class="list-group" style="max-height: 150px; overflow-y: auto;"></ul>
                        </div>
                        <div>
                            <label class="form-label small text-muted">بنود التقييم</label>
                            <div class="input-group mb-2">
                                <input type="text" id="new-criteria-name" class="form-control" placeholder="نص البند">
                                <button onclick="System.admin.addCriteria()" class="btn btn-warning text-dark"><i class="fas fa-plus"></i></button>
                            </div>
                            <ul id="criteria-list" class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-users" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-users-cog ms-2"></i>إدارة المستخدمين</h3>
            <div class="section-card">
                <h5 class="mb-3 text-muted">إضافة / تعديل مستخدم</h5>
                <input type="hidden" id="user-edit-id"> 
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small">الاسم الكامل</label>
                        <input type="text" id="user-fullname" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">اسم المستخدم</label>
                        <input type="text" id="user-username" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">كلمة المرور</label>
                        <input type="text" id="user-password" class="form-control" placeholder="تلقائي">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">رقم الجوال <span class="text-danger">*</span></label>
                        <input type="text" id="user-mobile" class="form-control" placeholder="9665xxxxxxxx">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">الدور الوظيفي</label>
                        <select id="user-role" class="form-select" onchange="System.ui.toggleUserFields()">
                            <option value="teacher">معلم</option>
                            <option value="coordinator">منسق</option>
                            <option value="supervisor">مشرف</option>
                            <option value="manager">مدير</option>
                            <option value="admin">مسؤول نظام</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button onclick="System.admin.saveUser()" id="btn-save-user" class="btn btn-success w-100">حفظ</button>
                        <button onclick="System.admin.cancelEditUser()" id="btn-cancel-user" class="btn btn-secondary w-100 hidden mt-1">إلغاء</button>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-light rounded border">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small">المدرسة:</label>
                            <select id="user-school-select" class="form-select" onchange="System.ui.renderScopeOptions()"></select>
                        </div>
                        <div class="col-md-4 hidden" id="field-subject">
                            <label class="form-label small">المادة:</label>
                            <select id="user-subject-select" class="form-select"></select>
                        </div>
                    </div>
                    <div id="scope-container" class="mt-3 hidden">
                        <label class="form-label small fw-bold text-primary">نطاق العمل (تسكين الصفوف):</label>
                        <div id="scope-options" class="d-flex flex-wrap gap-3 bg-white p-2 rounded border"></div>
                    </div>
                </div>
                <hr class="my-4">
                <h5 class="mb-3">قائمة المستخدمين</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>الاسم</th><th>اسم المستخدم</th><th>كلمة المرور</th><th>الجوال</th><th>الدور</th><th>المدرسة</th><th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-coordinator-entry" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-clipboard-check ms-2"></i>المتابعة اليومية وإدخال البنود</h3>
            
            <div class="section-card border-primary border-start border-4 mb-3">
                <div class="d-flex justify-content-between align-items-center cursor-pointer no-print" data-bs-toggle="collapse" data-bs-target="#assignPanel">
                    <h5 class="m-0 text-primary"><i class="fas fa-link ms-2"></i>تسكين المعلمين على الفصول</h5>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapse mt-3 no-print" id="assignPanel">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label class="small">المرحلة</label>
                            <select id="assign-stage" class="form-select form-select-sm" onchange="System.coordinator.updateAssignGrades()"></select>
                        </div>
                        <div class="col-md-3">
                            <label class="small">الصف</label>
                            <select id="assign-grade" class="form-select form-select-sm" onchange="System.coordinator.updateAssignClasses()"></select>
                        </div>
                        <div class="col-md-2">
                            <label class="small">الفصل</label>
                            <select id="assign-class" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-md-2">
                            <label class="small">المعلم</label>
                            <select id="assign-teacher" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-md-2">
                            <label class="small text-white">.</label>
                            <button onclick="System.coordinator.saveAssignment()" class="btn btn-primary btn-sm w-100">ربط</button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted fw-bold">التسكينات الحالية:</small>
                        <ul id="current-assignments-list" class="list-group list-group-flush small mt-1" style="max-height:100px; overflow-y:auto;"></ul>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="row g-2 mb-3 align-items-end no-print">
                    <div class="col-md-2">
                        <label class="form-label small">المرحلة</label>
                        <select id="entry-stage" class="form-select" onchange="System.coordinator.updateEntryGrades()"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">الصف</label>
                        <select id="entry-grade" class="form-select" onchange="System.coordinator.updateEntryClasses()"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">الفصل</label>
                        <select id="entry-class" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">الأسبوع</label>
                        <select id="entry-week" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">التاريخ</label>
                        <input type="date" id="entry-date" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <button onclick="System.coordinator.loadMatrix()" class="btn btn-dark w-100"><i class="fas fa-search ms-2"></i>عرض</button>
                    </div>
                </div>
                
                <h5 id="matrix-title" class="text-center text-primary mb-3"></h5>
                <div class="table-responsive">
                    <table class="table matrix-table table-bordered table-striped" id="matrix-table">
                        <thead class="table-light"><tr><th class="text-muted">الرجاء اختيار البيانات وعرض الجدول</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button onclick="System.coordinator.saveMatrix()" id="btn-save-matrix" class="btn btn-success mt-3 hidden w-100 no-print"><i class="fas fa-save ms-2"></i>حفظ التقييمات</button>
            </div>
        </div>

        <div id="view-dashboard" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-tachometer-alt ms-2"></i>حالة الرصد (لوحة التحكم)</h3>
            
            <div class="row mb-4" id="general-stats-row"></div>

            <div class="section-card bg-white border-top border-4 border-info">
                <div class="d-flex align-items-center mb-3 text-info">
                    <i class="fas fa-chart-pie fa-2x me-2"></i>
                    <h5 class="m-0 fw-bold">نسبة تفعيل البنود (إحصائية تفصيلية)</h5>
                    <div class="ms-auto d-flex gap-3 text-secondary small">
                        <span><i class="fas fa-user-shield"></i> أدمن</span>
                        <span><i class="fas fa-user-tie"></i> مدير</span>
                        <span><i class="fas fa-user-check"></i> مشرف</span>
                        <span><i class="fas fa-clipboard-list"></i> منسق</span>
                    </div>
                </div>
                
                <div class="row g-2 mb-3 bg-light p-3 rounded align-items-end">
                    <div class="col-md-3">
                        <label class="small fw-bold">المدرسة</label>
                        <select id="stats-school" class="form-select form-select-sm" onchange="System.dashboard.updateStatsFilters('school')">
                            <option value="all">الجميع</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold">الصف</label>
                        <select id="stats-grade" class="form-select form-select-sm" onchange="System.dashboard.updateStatsFilters('grade')">
                            <option value="all">الجميع</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold">الفصل</label>
                        <select id="stats-class" class="form-select form-select-sm">
                            <option value="all">الجميع</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-info text-white btn-sm w-100" onclick="System.dashboard.renderCriteriaStats()">عرض النسب</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-sm text-center align-middle" id="criteria-stats-table">
                        <thead class="table-secondary">
                            <tr>
                                <th>البند</th>
                                <th>عدد مرات التفعيل</th>
                                <th>إجمالي الزيارات</th>
                                <th>نسبة الأداء %</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="alert alert-info">يظهر هنا الفصول والبنود غير المرصودة للأسبوع الحالي.</div>
            
            <div class="row g-2 mb-3 no-print">
                <div class="col-md-3">
                    <select id="dash-week" class="form-select" onchange="System.dashboard.renderMonitoringStatus()">
                        </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary" onclick="System.dashboard.renderMonitoringStatus()">تحديث الحالة</button>
                </div>
            </div>

            <div class="section-card">
                <h5 class="mb-3">الفصول غير المكتملة الرصد</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="monitoring-table">
                        <thead class="table-danger">
                            <tr>
                                <th>المرحلة</th>
                                <th>الفصل</th>
                                <th>المعلم</th>
                                <th>المنسق المسؤول</th>
                                <th>البنود الناقصة</th>
                                <th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-notifications" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-bell ms-2"></i>مركز الإشعارات والتواصل</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="card bg-primary text-white mb-3">
                        <div class="card-body text-center">
                            <h1 class="display-4 fw-bold" id="notif-count-display">0</h1>
                            <p>عدد الإشعارات المرسلة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="section-card">
                        <h5 class="mb-3">سجل التواصل</h5>
                        <ul class="list-group" id="notif-list">
                            <li class="list-group-item text-muted">لا توجد إشعارات سابقة</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-procedures" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-gavel ms-2"></i>إجراءات المعلمين</h3>
            <div class="section-card no-print">
                <h5 class="mb-3">تسجيل إجراء جديد</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="small">المعلم</label>
                        <select id="proc-teacher" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small">النوع</label>
                        <select id="proc-type" class="form-select">
                            <option value="praise">إفادة شكر</option>
                            <option value="note">ملاحظة</option>
                            <option value="verbal_warning">تنبيه شفهي</option>
                            <option value="written_warning">تنبيه كتابي</option>
                            <option value="violation">مخالفة</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small">التاريخ</label>
                        <input type="date" id="proc-date" class="form-control">
                    </div>
                    <div class="col-md-3">
                         <label class="small">اليوم</label>
                         <input type="text" id="proc-day" class="form-control" placeholder="الأحد">
                    </div>
                    <div class="col-md-6">
                        <label class="small">نص الموقف</label>
                        <textarea id="proc-situation" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="small">الإجراء المتخذ</label>
                        <textarea id="proc-action" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12">
                        <button onclick="System.procedures.add()" class="btn btn-warning text-dark w-100 fw-bold">حفظ الإجراء</button>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h5 class="mb-3">سجل الإجراءات</h5>
                <div class="table-responsive">
                    <table class="table table-striped" id="procedures-table">
                        <thead class="table-dark">
                            <tr>
                                <th>المعلم</th><th>النوع</th><th>التاريخ</th><th>الموقف</th><th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-teacher-file" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-id-card ms-2"></i>ملف المعلم</h3>
            <div class="row mb-3 no-print">
                <div class="col-md-6">
                    <select id="file-teacher-select" class="form-select" onchange="System.teacherFile.render()">
                        <option value="">اختر المعلم لعرض ملفه...</option>
                    </select>
                </div>
            </div>

            <div id="teacher-file-content" class="hidden">
                <div class="section-card border-top border-5 border-primary">
                    <div class="d-flex justify-content-between">
                        <h4 id="tf-name">اسم المعلم</h4>
                        <span id="tf-school" class="badge bg-secondary">المدرسة</span>
                    </div>
                    <div class="row mt-4 text-center">
                        <div class="col-md-4">
                            <div class="card bg-success text-white p-3">
                                <h3 id="tf-praise-count">0</h3>
                                <small>عدد الثناءات</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-danger text-white p-3">
                                <h3 id="tf-violation-count">0</h3>
                                <small>المخالفات/التنبيهات</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-dark p-3">
                                <h3 id="tf-gaps-count">0</h3>
                                <small>حالات التقصير (بنود ناقصة)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <ul class="nav nav-tabs mb-3" id="teacherFileTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active text-danger" id="tab-negative-btn" data-bs-toggle="tab" data-bs-target="#tab-negative" type="button">
                                <i class="fas fa-exclamation-circle me-2"></i>التقصير والمخالفات
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link text-success" id="tab-positive-btn" data-bs-toggle="tab" data-bs-target="#tab-positive" type="button">
                                <i class="fas fa-star me-2"></i>الثناء والتميز
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-negative" role="tabpanel">
                            <h6 class="text-secondary border-bottom pb-2">سجل التقصير في البنود (من واقع المتابعة)</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-bordered table-striped" id="table-gaps">
                                    <thead class="table-light">
                                        <tr>
                                            <th>الفصل</th>
                                            <th>التاريخ / الأسبوع</th>
                                            <th>عدد بنود التقصير</th>
                                            <th>بنود التقصير</th>
                                            <th>نسبة الأداء %</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>

                            <h6 class="text-secondary border-bottom pb-2 mt-4">سجل المخالفات والتنبيهات الإدارية</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="table-violations">
                                    <thead class="table-danger text-white">
                                        <tr>
                                            <th>النوع</th>
                                            <th>التاريخ</th>
                                            <th>الموقف</th>
                                            <th>الإجراء المتخذ</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-positive" role="tabpanel">
                            <h6 class="text-secondary border-bottom pb-2">سجل الثناء والشكر</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-success" id="table-praise">
                                    <thead class="text-white bg-success">
                                        <tr>
                                            <th>الفصل / السياق</th>
                                            <th>التاريخ</th>
                                            <th>نوع الإفادة</th>
                                            <th>سبب الثناء</th>
                                            <th>الإجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section hidden">
            <h3 class="mb-4 text-primary"><i class="fas fa-chart-pie ms-2"></i>التقارير والإحصائيات</h3>
            <div class="section-card">
                
                <div class="row g-2 mb-4 no-print bg-light p-3 rounded border" id="report-filters">
                    <div class="col-md-2"><label class="small fw-bold">المدرسة</label><select id="rep-school" class="form-select form-select-sm" onchange="System.reports.updateFilters('school')"><option value="all">الكل</option></select></div>
                    <div class="col-md-2"><label class="small fw-bold">المرحلة</label><select id="rep-stage" class="form-select form-select-sm" onchange="System.reports.updateFilters('stage')"><option value="all">الكل</option></select></div>
                    <div class="col-md-2"><label class="small fw-bold">الصف</label><select id="rep-grade" class="form-select form-select-sm"><option value="all">الكل</option></select></div>
                    <div class="col-md-2"><label class="small fw-bold">المادة</label><select id="rep-subject" class="form-select form-select-sm"><option value="all">الكل</option></select></div>
                    <div class="col-md-2"><label class="small fw-bold">الأسبوع</label><select id="rep-week" class="form-select form-select-sm"><option value="all">الكل</option></select></div>
                    <div class="col-md-2"><button onclick="System.reports.generate()" class="btn btn-primary btn-sm w-100 mt-4">عرض التقرير</button></div>
                </div>

                <ul class="nav nav-tabs mb-3 no-print" id="reportsTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button">الإحصائيات والرسوم</button></li>
                    <li class="nav-item"><button class="nav-link" id="perf-tab" data-bs-toggle="tab" data-bs-target="#perf" type="button">تقرير الأداء</button></li>
                    <li class="nav-item"><button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button">جدول البيانات الشامل</button></li>
                </ul>

                <div class="tab-content" id="reportsTabContent">
                    <div class="tab-pane fade show active" id="stats" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card p-2"><h6 class="text-center">الأداء العام</h6><canvas id="chart-pie"></canvas></div>
                            </div>
                            <div class="col-md-8 mb-3">
                                <div class="card p-2"><h6 class="text-center">أداء المعلمين (الأعلى نقاطاً)</h6><canvas id="chart-bar"></canvas></div>
                            </div>
                            <div class="col-12">
                                <div class="card p-2"><h6 class="text-center">معدل الإنجاز عبر الأسابيع</h6><canvas id="chart-line"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="perf" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="report-table">
                                <thead class="table-light">
                                    <tr><th>المدرسة</th><th>المعلم</th><th>المادة</th><th>عدد بنود التفعيل</th><th>النسبة %</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="data" role="tabpanel">
                         <div class="d-flex justify-content-end mb-2">
                             <button class="btn btn-sm btn-outline-secondary" onclick="window.print()"><i class="fas fa-print"></i> طباعة الجدول</button>
                          </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm small" id="detailed-data-table">
                                <thead class="table-dark">
                                    </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    
    // ============================================
    // بداية كود الحماية (منع الزر الأيمن + المصدر)
    // ============================================

    // منع القائمة المنسدلة للزر الأيمن
    document.addEventListener('contextmenu', event => event.preventDefault());

    // منع اختصارات لوحة المفاتيح الخاصة بالمطورين والمصدر
    document.onkeydown = function(e) {
        // F12
        if(e.keyCode == 123) {
            return false;
        }
        // Ctrl+Shift+I (فتح أدوات المطور)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
            return false;
        }
        // Ctrl+Shift+C (فتح أدوات المطور - العناصر)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) {
            return false;
        }
        // Ctrl+Shift+J (فتح أدوات المطور - الكونسول)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
            return false;
        }
        // Ctrl+U (عرض مصدر الصفحة)
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
            return false;
        }
    }
    
    // ============================================
    // نهاية كود الحماية
    // ============================================


    /**
     * FIREBASE CONFIGURATION
     * هام: قم باستبدال القيم أدناه بالقيم الخاصة بمشروعك من Firebase Console
     */
    const firebaseConfig = {
        apiKey: "AIzaSyA9tT1zrFB9nXuWCTZNr8Am_EaONJPz7Qc",
        authDomain: "follow-teachers.firebaseapp.com",
        databaseURL: "https://follow-teachers-default-rtdb.firebaseio.com/",
        projectId: "follow-teachers",
        storageBucket: "follow-teachers.firebasestorage.app",
        messagingSenderId: "513455359277",
        appId: "1:513455359277:web:56f0d60070aaa0b0f13fa4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    /**
     * CORE SYSTEM LOGIC V4.5 (Enhanced + Firebase)
     */
    const DB_KEY = 'EduTrackerDB_v4_5';
    
    const defaultData = {
        users: [
            {id: 1, name: 'مدير النظام', username: 'Mahmod', password: 'Ma@521990', role: 'admin', mobile: '966509635561', schoolId: null, scope: {}}
        ],
        schools: [], 
        subjects: [],
        weeks: [],
        criteria: [
            {id: 'c1', name: 'تحضير الدروس'}, {id: 'c2', name: 'استخدام التقنية'}, 
            {id: 'c3', name: 'الواجبات'}, {id: 'c4', name: 'المشاركة الصفية'}
        ],
        assignments: [], 
        evaluations: [], 
        procedures: [],  
        notifications: [] 
    };

    const System = {
        data: null,
        currentUser: null,

        // MODIFIED FOR FIREBASE
        init: function() {
            const loader = document.getElementById('loader');
            const dbRef = firebase.database().ref(DB_KEY);

            dbRef.once('value').then((snapshot) => {
                const val = snapshot.val();
                if (val) {
                    this.data = val;
                    // FIX: Ensure all arrays are initialized if Firebase returned null/undefined for them
                    // هذا الجزء هو الحل للمشكلة: التأكد من أن القوائم موجودة حتى لو كانت فارغة
                    const keys = ['schools', 'subjects', 'weeks', 'criteria', 'users', 'assignments', 'evaluations', 'procedures', 'notifications'];
                    keys.forEach(key => {
                        if (!this.data[key]) this.data[key] = [];
                    });
                } else {
                    // First time load: save default data to Firebase
                    this.data = JSON.parse(JSON.stringify(defaultData));
                    this.save();
                }

                // Initial Data Checks - Extra Safety
                if(!this.data.procedures) this.data.procedures = [];
                if(!this.data.notifications) this.data.notifications = [];
                
                // Hide Loader
                loader.classList.add('hidden');
                document.getElementById('login-section').classList.remove('hidden');

                // Check Session
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    this.currentUser = JSON.parse(sessionUser);
                    this.auth.postLoginInit();
                }
            }).catch((error) => {
                console.error("Firebase connection error:", error);
                alert("حدث خطأ أثناء الاتصال بقاعدة البيانات. يرجى التحقق من الإعدادات.");
            });
        },

        // MODIFIED FOR FIREBASE
        save: function() {
            // Asynchronous save to Firebase
            firebase.database().ref(DB_KEY).set(this.data)
                .then(() => {
                    console.log('Data synced successfully');
                })
                .catch((error) => {
                    console.error('Data sync failed', error);
                    alert('تحذير: فشل حفظ البيانات في السحابة');
                });
        },

        // --- AUTH ---
        auth: {
            login: function() {
                const u = document.getElementById('login-username').value;
                const p = document.getElementById('login-password').value;
                const user = System.data.users.find(x => x.username === u && x.password === p);
                
                if (user) {
                    System.currentUser = user;
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    this.postLoginInit();
                } else {
                    alert('بيانات الدخول غير صحيحة');
                }
            },
            logout: function() {
                sessionStorage.removeItem('currentUser');
                location.reload();
            },
            postLoginInit: function() {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                document.getElementById('sidebar-username').innerText = System.currentUser.name;
                document.getElementById('top-bar-user').innerText = System.currentUser.name;
                document.getElementById('sidebar-initials').innerText = System.currentUser.name.charAt(0);
                
                const roleMap = { 'admin':'مدير النظام', 'manager':'مدير تعليمي', 'supervisor':'مشرف', 'coordinator':'منسق', 'teacher':'معلم' };
                document.getElementById('sidebar-role').innerText = roleMap[System.currentUser.role];

                System.ui.buildSidebar();
                System.ui.updateNotificationCount();
                
                // Redirect based on role
                if(System.currentUser.role === 'admin') System.ui.showView('view-admin-structure');
                else if(System.currentUser.role === 'coordinator') System.ui.showView('view-coordinator-entry');
                else System.ui.showView('view-dashboard');
            }
        },

        // --- UI & UTILS ---
        ui: {
            buildSidebar: function() {
                const menu = document.getElementById('sidebar-menu');
                menu.innerHTML = '';
                const role = System.currentUser.role;
                
                const addLink = (id, text, icon) => menu.innerHTML += `<a href="#" onclick="System.ui.showView('${id}')" id="link-${id}"><i class="fas ${icon} ms-2"></i>${text}</a>`;

                if (role === 'admin') {
                    addLink('view-admin-structure', 'الهيكل والإعدادات', 'fa-cogs');
                    addLink('view-users', 'المستخدمين', 'fa-users');
                }
                if (['admin', 'manager', 'supervisor', 'coordinator'].includes(role)) {
                    addLink('view-dashboard', 'حالة الرصد', 'fa-tachometer-alt');
                    addLink('view-procedures', 'الإجراءات', 'fa-gavel');
                    addLink('view-teacher-file', 'ملف المعلم', 'fa-id-card');
                }
                if (role === 'coordinator' || role === 'manager') {
                    addLink('view-coordinator-entry', 'إدخال البنود', 'fa-edit');
                }
                if (role !== 'teacher') { 
                    addLink('view-reports', 'التقارير', 'fa-chart-bar');
                }
            },
            
            showView: function(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));
                
                const target = document.getElementById(viewId);
                if(target) target.classList.remove('hidden');
                const link = document.getElementById('link-' + viewId);
                if(link) link.classList.add('active');

                // Page Header Title
                const titles = {'view-admin-structure':'الإعدادات', 'view-users':'المستخدمين', 'view-coordinator-entry':'إدخال البيانات', 'view-dashboard':'لوحة التحكم', 'view-notifications':'الإشعارات', 'view-reports':'التقارير'};
                document.getElementById('page-header-title').innerText = titles[viewId] || '';

                // Init Logic per View
                if(viewId === 'view-admin-structure') System.admin.renderAllLists();
                if(viewId === 'view-users') System.admin.initUserView();
                if(viewId === 'view-coordinator-entry') System.coordinator.init();
                if(viewId === 'view-dashboard') System.dashboard.init();
                if(viewId === 'view-reports') System.reports.init();
                if(viewId === 'view-notifications') System.notifications.render();
                if(viewId === 'view-procedures') System.procedures.init();
                if(viewId === 'view-teacher-file') System.teacherFile.init();
            },

            updateNotificationCount: function() {
                const count = System.data.notifications.length;
                document.getElementById('nav-badge').innerText = count;
                document.getElementById('notif-count-display').innerText = count;
            },

            // For Admin Structure Only
            updateStagesDropdown: function(schoolSelectId = 'struct-school-select', stageSelectId = 'struct-stage-select') {
                const schoolId = parseInt(document.getElementById(schoolSelectId).value);
                const stageSelect = document.getElementById(stageSelectId);
                stageSelect.innerHTML = '<option value="">اختر المرحلة</option>';
                const school = System.data.schools.find(s => s.id === schoolId);
                if(school && school.stages) school.stages.forEach(s => stageSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                this.updateGradesDropdown(schoolSelectId, stageSelectId, 'struct-grade-select');
            },

            updateGradesDropdown: function(schoolIdRef = 'struct-school-select', stageIdRef = 'struct-stage-select', targetId = 'struct-grade-select') {
                const schoolId = parseInt(document.getElementById(schoolIdRef).value);
                const stageId = document.getElementById(stageIdRef).value;
                const gradeSelect = document.getElementById(targetId);
                gradeSelect.innerHTML = '<option value="">اختر الصف</option>';
                const school = System.data.schools.find(s => s.id === schoolId);
                if(school) {
                    const stage = school.stages.find(s => s.id === stageId);
                    if(stage && stage.grades) stage.grades.forEach(g => gradeSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`);
                }
            },
            
            toggleUserFields: function() {
                const role = document.getElementById('user-role').value;
                const fieldSub = document.getElementById('field-subject');
                const scopeContainer = document.getElementById('scope-container');
                if(['teacher', 'supervisor'].includes(role)) fieldSub.classList.remove('hidden'); else fieldSub.classList.add('hidden');
                if(['coordinator', 'manager', 'teacher'].includes(role)) scopeContainer.classList.remove('hidden'); else scopeContainer.classList.add('hidden');
                this.renderScopeOptions();
            },

            renderScopeOptions: function() {
                const schoolId = parseInt(document.getElementById('user-school-select').value);
                const container = document.getElementById('scope-options');
                container.innerHTML = '';
                const school = System.data.schools.find(s => s.id === schoolId);
                if(!school || !school.stages) { container.innerHTML = '<small class="text-muted">الرجاء اختيار مدرسة صالحة</small>'; return; }
                school.stages.forEach(stage => {
                    let html = `<div class="border p-2 rounded bg-light" style="min-width: 150px;"><strong class="d-block border-bottom mb-1 text-primary">${stage.name}</strong>`;
                    if(stage.grades) stage.grades.forEach(g => {
                        html += `<div class="form-check"><input class="form-check-input scope-check" type="checkbox" value="${stage.id}|${g.id}" id="sc_${g.id}"><label class="form-check-label small" for="sc_${g.id}">${g.name}</label></div>`;
                    });
                    html += `</div>`;
                    container.innerHTML += html;
                });
            }
        },

        // --- ADMIN ---
        admin: {
            genId: () => '_' + Math.random().toString(36).substr(2, 9),
            renderAllLists: function() {
                this.renderList('schools', System.data.schools);
                this.renderList('subjects', System.data.subjects);
                this.renderList('weeks', System.data.weeks);
                this.renderList('criteria', System.data.criteria);
                const sel = document.getElementById('struct-school-select');
                sel.innerHTML = '<option value="">اختر المدرسة</option>';
                System.data.schools.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                this.renderStructurePreview();
            },
            renderList: function(type, dataArray) {
                const ul = document.getElementById(type + '-list');
                ul.innerHTML = '';
                if(dataArray && dataArray.length > 0){
                    dataArray.forEach(item => {
                        ul.innerHTML += `<li class="list-group-item"><span>${item.name}</span><div><i class="fas fa-edit text-warning action-btn" onclick="System.admin.editItem('${type}', '${item.id}')"></i><i class="fas fa-trash text-danger action-btn" onclick="System.admin.deleteItem('${type}', '${item.id}')"></i></div></li>`;
                    });
                }
            },
            renderStructurePreview: function() {
                const container = document.getElementById('structure-preview');
                container.innerHTML = '';
                System.data.schools.forEach(s => {
                    let html = `<div class="mb-2"><strong class="text-primary"><i class="fas fa-school"></i> ${s.name}</strong><ul class="mb-1">`;
                    if(s.stages) s.stages.forEach(st => {
                        html += `<li>${st.name} <i class="fas fa-pen text-secondary fs-6 cursor-pointer" onclick="System.admin.editSubItem('stage', ${s.id}, '${st.id}')"></i> <i class="fas fa-times text-danger fs-6 cursor-pointer" onclick="System.admin.deleteSubItem('stage', ${s.id}, '${st.id}')"></i><ul>`;
                        if(st.grades) st.grades.forEach(g => {
                            html += `<li>${g.name} <i class="fas fa-pen text-secondary fs-6 cursor-pointer" onclick="System.admin.editSubItem('grade', ${s.id}, '${st.id}', '${g.id}')"></i> <i class="fas fa-times text-danger fs-6 cursor-pointer" onclick="System.admin.deleteSubItem('grade', ${s.id}, '${st.id}', '${g.id}')"></i> : `;
                            if(g.classes) g.classes.forEach(c => { html += `<span class="badge bg-light text-dark border me-1">${c.name} <i class="fas fa-times text-danger ms-1 cursor-pointer" onclick="System.admin.deleteSubItem('class', ${s.id}, '${st.id}', '${g.id}', '${c.id}')"></i></span>`; });
                            html += `</li>`;
                        });
                        html += `</ul></li>`;
                    });
                    html += `</ul></div>`;
                    container.innerHTML += html;
                });
            },
            addSchool: function() { 
                const n = document.getElementById('new-school-name').value; 
                if(n) { 
                    // Safety check to ensure array exists
                    if(!System.data.schools) System.data.schools = [];
                    System.data.schools.push({id: Date.now(), name: n, stages:[]}); 
                    System.save(); 
                    this.renderAllLists(); 
                    document.getElementById('new-school-name').value=''; 
                } 
            },
            addStage: function() { const sid = parseInt(document.getElementById('struct-school-select').value), n = document.getElementById('new-stage-name').value; if(sid && n) { System.data.schools.find(s=>s.id===sid).stages.push({id: this.genId(), name: n, grades:[]}); System.save(); System.ui.updateStagesDropdown(); this.renderStructurePreview(); } },
            addGrade: function() { const sid = parseInt(document.getElementById('struct-school-select').value), stid = document.getElementById('struct-stage-select').value, n = document.getElementById('new-grade-name').value; if(stid && n) { System.data.schools.find(s=>s.id===sid).stages.find(s=>s.id===stid).grades.push({id: this.genId(), name: n, classes:[]}); System.save(); System.ui.updateGradesDropdown(); this.renderStructurePreview(); } },
            addClass: function() { const sid = parseInt(document.getElementById('struct-school-select').value), stid = document.getElementById('struct-stage-select').value, gid = document.getElementById('struct-grade-select').value, n = document.getElementById('new-class-name').value; if(gid && n) { System.data.schools.find(s=>s.id===sid).stages.find(s=>s.id===stid).grades.find(g=>g.id===gid).classes.push({id: this.genId(), name: n}); System.save(); this.renderStructurePreview(); } },
            addSubject: function() { const n = document.getElementById('new-subject-name').value; if(n) { if(!System.data.subjects) System.data.subjects = []; System.data.subjects.push({id: Date.now(), name: n}); System.save(); this.renderList('subjects', System.data.subjects); document.getElementById('new-subject-name').value=''; } },
            addWeek: function() { const n = document.getElementById('new-week-name').value; if(n) { if(!System.data.weeks) System.data.weeks = []; System.data.weeks.push({id: Date.now(), name: n}); System.save(); this.renderList('weeks', System.data.weeks); document.getElementById('new-week-name').value=''; } },
            addCriteria: function() { const n = document.getElementById('new-criteria-name').value; if(n) { if(!System.data.criteria) System.data.criteria = []; System.data.criteria.push({id: Date.now(), name: n}); System.save(); this.renderList('criteria', System.data.criteria); document.getElementById('new-criteria-name').value=''; } },
            
            // --- Edit Functions ---
            editItem: function(type, id) {
                const isNum = type === 'schools' || type === 'subjects' || type === 'weeks' || type === 'criteria';
                const searchId = isNum ? parseInt(id) : id;
                const item = System.data[type].find(x => x.id === searchId);
                if(item) {
                    const newName = prompt('تعديل الاسم:', item.name);
                    if(newName && newName !== item.name) {
                        item.name = newName;
                        System.save();
                        this.renderAllLists();
                    }
                }
            },
            editSubItem: function(type, sid, stid, gid, cid) {
                const s = System.data.schools.find(x => x.id === sid);
                if(!s) return;

                if (type === 'stage') {
                    const st = s.stages.find(x => x.id === stid);
                    if(st) {
                         const newName = prompt('تعديل اسم المرحلة:', st.name);
                         if(newName) { st.name = newName; System.save(); this.renderStructurePreview(); }
                    }
                } else if (type === 'grade') {
                    const st = s.stages.find(x => x.id === stid);
                    const g = st.grades.find(x => x.id === gid);
                    if(g) {
                         const newName = prompt('تعديل اسم الصف:', g.name);
                         if(newName) { g.name = newName; System.save(); this.renderStructurePreview(); }
                    }
                }
            },
            // --- End Edit Functions ---

            deleteItem: function(type, id) { if(confirm('حذف؟')) { if(type==='schools') id=parseInt(id); else id=isNaN(id)?id:parseInt(id); System.data[type] = System.data[type].filter(x => x.id !== id); System.save(); this.renderAllLists(); } },
            deleteSubItem: function(type, sid, stid, gid, cid) { if(!confirm('حذف؟')) return; const s = System.data.schools.find(x=>x.id===sid), st = s.stages.find(x=>x.id===stid); if(type==='stage') s.stages = s.stages.filter(x=>x.id!==stid); else if(type==='grade') st.grades = st.grades.filter(x=>x.id!==gid); else if(type==='class') { const g = st.grades.find(x=>x.id===gid); g.classes = g.classes.filter(x=>x.id!==cid); } System.save(); this.renderStructurePreview(); },
            
            // Users
            initUserView: function() {
                const schSel = document.getElementById('user-school-select'); schSel.innerHTML = '<option value="">اختر المدرسة</option>';
                System.data.schools.forEach(s => schSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                const subSel = document.getElementById('user-subject-select'); subSel.innerHTML = '<option value="">اختر المادة</option>';
                System.data.subjects.forEach(s => subSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                this.renderUsersTable();
            },
            saveUser: function() {
                const id = document.getElementById('user-edit-id').value;
                const name = document.getElementById('user-fullname').value;
                const username = document.getElementById('user-username').value;
                const mobile = document.getElementById('user-mobile').value;
                const password = document.getElementById('user-password').value; 
                const role = document.getElementById('user-role').value;
                const schoolId = parseInt(document.getElementById('user-school-select').value);
                const subjectId = document.getElementById('user-subject-select').value;
                
                if(!name || !username || !schoolId || !mobile) return alert('البيانات ناقصة (بما في ذلك الجوال والمدرسة)');
                
                const scope = { stageIds: [], gradeIds: [] };
                document.querySelectorAll('.scope-check:checked').forEach(cb => { const [st, gr] = cb.value.split('|'); if(!scope.stageIds.includes(st)) scope.stageIds.push(st); scope.gradeIds.push(gr); });
                
                const generatedPass = System.utils.generatePassword();
                const finalPassword = password ? password : (id ? null : generatedPass); 

                const userObj = { 
                    id: id ? parseInt(id) : Date.now(), 
                    name, 
                    username, 
                    role, 
                    schoolId, 
                    mobile, 
                    subjectId: subjectId?parseInt(subjectId):null, 
                    scope 
                };

                if (finalPassword) userObj.password = finalPassword;
                else {
                      const existing = System.data.users.find(u=>u.id==id);
                      if(existing) userObj.password = existing.password;
                      else userObj.password = generatedPass;
                }
                
                if(id) { const idx = System.data.users.findIndex(u=>u.id==id); System.data.users[idx] = {...System.data.users[idx], ...userObj}; }
                else { System.data.users.push(userObj); }
                System.save(); this.cancelEditUser(); this.renderUsersTable();
            },
            renderUsersTable: function() {
                const tbody = document.getElementById('users-table-body'); tbody.innerHTML = '';
                System.data.users.forEach(u => {
                    const sName = System.data.schools.find(s=>s.id === u.schoolId)?.name || '-';
                    tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.username}</td><td>${u.password}</td><td>${u.mobile||'-'}</td><td>${u.role}</td><td>${sName}</td><td><button class="btn btn-sm btn-warning" onclick="System.admin.loadUser(${u.id})"><i class="fas fa-pen"></i></button> <button class="btn btn-sm btn-danger" onclick="System.admin.delUser(${u.id})"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            },
            loadUser: function(id) {
                const u = System.data.users.find(x => x.id === id);
                document.getElementById('user-edit-id').value = u.id;
                document.getElementById('user-fullname').value = u.name;
                document.getElementById('user-username').value = u.username;
                document.getElementById('user-password').value = u.password; 
                document.getElementById('user-mobile').value = u.mobile || '';
                document.getElementById('user-role').value = u.role;
                document.getElementById('user-school-select').value = u.schoolId;
                System.ui.toggleUserFields();
                if(u.subjectId) document.getElementById('user-subject-select').value = u.subjectId;
                setTimeout(() => { if(u.scope && u.scope.gradeIds) u.scope.gradeIds.forEach(gid => { const cb = document.querySelector(`.scope-check[value*="${gid}"]`); if(cb) cb.checked = true; }); }, 100);
                document.getElementById('btn-save-user').innerText = 'تحديث'; document.getElementById('btn-cancel-user').classList.remove('hidden');
            },
            cancelEditUser: function() {
                document.getElementById('user-edit-id').value = ''; 
                document.getElementById('user-fullname').value = ''; 
                document.getElementById('user-username').value = ''; 
                document.getElementById('user-password').value = ''; 
                document.getElementById('user-mobile').value = '';
                document.getElementById('user-school-select').value = ''; 
                document.getElementById('btn-save-user').innerText = 'حفظ المستخدم'; 
                document.getElementById('btn-cancel-user').classList.add('hidden'); 
                document.getElementById('scope-options').innerHTML = '';
            },
            delUser: function(id) { if(confirm('حذف؟')) { System.data.users = System.data.users.filter(u => u.id !== id); System.save(); this.renderUsersTable(); } }
        },

        // --- COORDINATOR ---
        coordinator: {
            init: function() {
                const user = System.currentUser;
                const school = System.data.schools.find(s => s.id === user.schoolId);
                if(!school) return;
                
                const populateStages = (selId) => {
                    const sel = document.getElementById(selId); sel.innerHTML = '<option value="">اختر المرحلة</option>';
                    const stagesToShow = user.scope?.stageIds?.length ? school.stages.filter(s => user.scope.stageIds.includes(s.id)) : school.stages;
                    if(stagesToShow) stagesToShow.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                };
                populateStages('entry-stage'); populateStages('assign-stage');
                
                const wSel = document.getElementById('entry-week'); wSel.innerHTML = '';
                System.data.weeks.forEach(w => wSel.innerHTML += `<option value="${w.id}">${w.name}</option>`);

                const tSel = document.getElementById('assign-teacher'); tSel.innerHTML = '';
                System.data.users.filter(u => u.schoolId === user.schoolId && u.role === 'teacher').forEach(t => {
                    tSel.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
                this.renderCurrentAssignments();
                document.getElementById('entry-date').valueAsDate = new Date();
            },
            
            updateAssignGrades: function() { 
                const schoolId = System.currentUser.schoolId;
                const stageId = document.getElementById('assign-stage').value;
                const gradeSelect = document.getElementById('assign-grade');
                gradeSelect.innerHTML = '<option value="">اختر الصف</option>';
                const school = System.data.schools.find(s => s.id === schoolId);
                if(school) {
                    const stage = school.stages.find(s => s.id === stageId);
                    if(stage && stage.grades) stage.grades.forEach(g => gradeSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`);
                }
            }, 
            updateAssignClasses: function() { 
                const schoolId = System.currentUser.schoolId;
                const gradeId = document.getElementById('assign-grade').value;
                const stageId = document.getElementById('assign-stage').value;
                const cSel = document.getElementById('assign-class'); 
                cSel.innerHTML = '';
                const school = System.data.schools.find(s => s.id === schoolId);
                if(school && stageId && gradeId) {
                    const stage = school.stages.find(s => s.id === stageId);
                    const grade = stage.grades.find(g => g.id === gradeId);
                    if(grade && grade.classes) grade.classes.forEach(c => cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
                }
            },
            updateEntryGrades: function() { 
                const schoolId = System.currentUser.schoolId;
                const stageId = document.getElementById('entry-stage').value;
                const gradeSelect = document.getElementById('entry-grade');
                gradeSelect.innerHTML = '<option value="">اختر الصف</option>';
                const school = System.data.schools.find(s => s.id === schoolId);
                if(school) {
                    const stage = school.stages.find(s => s.id === stageId);
                    if(stage && stage.grades) stage.grades.forEach(g => gradeSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`);
                }
            },
            updateEntryClasses: function() {
                 const schoolId = System.currentUser.schoolId;
                 const stageId = document.getElementById('entry-stage').value;
                 const gradeId = document.getElementById('entry-grade').value;
                 const cSel = document.getElementById('entry-class'); 
                 cSel.innerHTML = '<option value="">اختر الفصل</option>';
                 const school = System.data.schools.find(s => s.id === schoolId);
                 if(school && stageId && gradeId) {
                    const stage = school.stages.find(s => s.id === stageId);
                    const grade = stage.grades.find(g => g.id === gradeId);
                    if(grade && grade.classes) grade.classes.forEach(c => cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
                 }
            },

            saveAssignment: function() {
                const tId = parseInt(document.getElementById('assign-teacher').value), cId = document.getElementById('assign-class').value;
                if(!tId || !cId) return alert('بيانات ناقصة');
                if(System.data.assignments.find(a => a.teacherId === tId && a.classId === cId)) return alert('مضاف مسبقاً');
                const user = System.data.users.find(u => u.id === tId);
                System.data.assignments.push({ id: Date.now(), teacherId: tId, classId: cId, subjectId: user.subjectId });
                System.save(); this.renderCurrentAssignments();
            },
            renderCurrentAssignments: function() {
                const list = document.getElementById('current-assignments-list'); list.innerHTML = '';
                const schoolUsers = System.data.users.filter(u => u.schoolId === System.currentUser.schoolId).map(u => u.id);
                System.data.assignments.filter(a => schoolUsers.includes(a.teacherId)).forEach(a => {
                    const t = System.data.users.find(u => u.id === a.teacherId);
                    let cName = '؟';
                    System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === a.classId) cName = `${g.name} - ${c.name}`; }))));
                    list.innerHTML += `<li class="list-group-item py-1"><span>${t.name} -> ${cName}</span><i class="fas fa-times text-danger cursor-pointer" onclick="System.coordinator.delAssignment(${a.id})"></i></li>`;
                });
            },
            delAssignment: function(id) { System.data.assignments = System.data.assignments.filter(a => a.id !== id); System.save(); this.renderCurrentAssignments(); },
            
            loadMatrix: function() {
                const classId = document.getElementById('entry-class').value;
                const weekId = parseInt(document.getElementById('entry-week').value);
                if(!classId || !weekId) return alert('اختر الفصل والاسبوع');
                
                let className = "";
                System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === classId) className = `${s.name} - ${st.name} - ${g.name} - ${c.name}`; }))));
                const weekName = System.data.weeks.find(w => w.id === weekId)?.name;
                const dateVal = document.getElementById('entry-date').value;
                document.getElementById('matrix-title').innerHTML = `تقييم ${className} | ${weekName} <br> <span class="text-dark small">${dateVal}</span>`;

                const assignments = System.data.assignments.filter(a => a.classId === classId);
                if(assignments.length === 0) return document.querySelector('#matrix-table tbody').innerHTML = '<tr><td colspan="100">لا يوجد معلمون مسكنون</td></tr>';

                const table = document.querySelector('#matrix-table');
                let thead = `<tr><th>المعيار</th>`;
                const teachers = [];
                assignments.forEach(a => {
                    const t = System.data.users.find(u => u.id === a.teacherId);
                    const sub = System.data.subjects.find(s => s.id === t.subjectId)?.name || '';
                    teachers.push({t, sub});
                    thead += `<th>${t.name}<br><small class="text-secondary">${sub}</small></th>`;
                });
                thead += `</tr>`;
                table.querySelector('thead').innerHTML = thead;

                let tbody = '';
                System.data.criteria.forEach(crit => {
                    tbody += `<tr><td>${crit.name}</td>`;
                    teachers.forEach(item => {
                        const existing = System.data.evaluations.find(e => e.weekId === weekId && e.classId === classId && e.teacherId === item.t.id && e.criteriaId === crit.id);
                        tbody += `<td><input type="checkbox" class="checkbox-cell" data-tid="${item.t.id}" data-cid="${crit.id}" ${existing ? 'checked' : ''}></td>`;
                    });
                    tbody += `</tr>`;
                });
                
                tbody += `<tr><td class="bg-light fw-bold">ملاحظات</td>`;
                teachers.forEach(item => {
                    const existing = System.data.evaluations.find(e => e.weekId === weekId && e.classId === classId && e.teacherId === item.t.id);
                    const noteText = existing ? (existing.notes || '') : '';
                    tbody += `<td><textarea class="form-control teacher-note" data-tid="${item.t.id}" rows="2" placeholder="ملاحظات...">${noteText}</textarea></td>`;
                });
                tbody += `</tr>`;

                table.querySelector('tbody').innerHTML = tbody;
                document.getElementById('btn-save-matrix').classList.remove('hidden');
            },
            saveMatrix: function() {
                const classId = document.getElementById('entry-class').value;
                const weekId = parseInt(document.getElementById('entry-week').value);
                const date = document.getElementById('entry-date').value;
                
                const tids = [...new Set(Array.from(document.querySelectorAll('.checkbox-cell')).map(c => parseInt(c.dataset.tid)))];
                
                System.data.evaluations = System.data.evaluations.filter(e => !(e.weekId === weekId && e.classId === classId && tids.includes(e.teacherId)));
                
                document.querySelectorAll('.checkbox-cell:checked').forEach(cb => {
                    const tid = parseInt(cb.dataset.tid);
                    const note = document.querySelector(`.teacher-note[data-tid="${tid}"]`)?.value || '';
                    System.data.evaluations.push({ weekId, classId, teacherId: tid, criteriaId: isNaN(cb.dataset.cid)?cb.dataset.cid:parseInt(cb.dataset.cid), value: 1, date, notes: note });
                });
                
                System.save(); alert('تم الحفظ');
            }
        },

        // --- DASHBOARD (Monitoring Status) ---
        dashboard: {
            init: function() {
                const wSel = document.getElementById('dash-week'); wSel.innerHTML = '';
                System.data.weeks.forEach(w => wSel.innerHTML += `<option value="${w.id}">${w.name}</option>`);
                this.renderStats();
                this.renderMonitoringStatus();
                this.updateStatsFilters('all');
            },
            renderStats: function() {
                const container = document.getElementById('general-stats-row');
                const u = System.currentUser;
                let html = '';
                
                const countUsers = System.data.users.length;
                const countSchools = System.data.schools.length;
                const countAssign = System.data.assignments.length;
                const countNotifs = System.data.notifications.length;

                const createCard = (title, val, color, icon) => `
                    <div class="col-md-3">
                        <div class="stat-card bg-${color}">
                            <h3>${val}</h3>
                            <p>${title}</p>
                            <i class="fas ${icon}"></i>
                        </div>
                    </div>`;

                if (u.role === 'admin') {
                    html += createCard('المدارس', countSchools, 'primary', 'fa-school');
                    html += createCard('المستخدمين', countUsers, 'success', 'fa-users');
                }
                html += createCard('التسكينات', countAssign, 'warning', 'fa-link');
                html += createCard('الإشعارات', countNotifs, 'danger', 'fa-bell');
                
                container.innerHTML = html;
            },
            renderMonitoringStatus: function() {
                const weekId = parseInt(document.getElementById('dash-week').value);
                const tbody = document.querySelector('#monitoring-table tbody'); tbody.innerHTML = '';
                
                const criteriaCount = System.data.criteria.length;
                let incompleteCount = 0;

                System.data.assignments.forEach(assign => {
                    const teacher = System.data.users.find(u => u.id === assign.teacherId);
                    if(!teacher) return;
                    
                    const viewer = System.currentUser;
                    if(viewer.role !== 'admin' && teacher.schoolId !== viewer.schoolId) return;
                    if(viewer.role === 'coordinator' && (!viewer.scope?.gradeIds?.includes(this.getGradeId(assign.classId)))) return; 

                    const evals = System.data.evaluations.filter(e => e.weekId === weekId && e.classId === assign.classId && e.teacherId === teacher.id);
                    const missingCount = criteriaCount - evals.length;
                    
                    const missingIds = System.data.criteria.map(c => c.id).filter(cid => !evals.find(e => e.criteriaId === cid));
                    const missingNames = missingIds.map(id => System.data.criteria.find(c => c.id === id).name);

                    if(missingCount > 0) {
                        incompleteCount++;
                        let stageName='', className='', gradeId='';
                        System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === assign.classId) { stageName = st.name; className = `${g.name} - ${c.name}`; gradeId=g.id; } }))));
                        
                        const coords = System.data.users.filter(u => u.role === 'coordinator' && u.schoolId === teacher.schoolId && u.scope?.gradeIds?.includes(gradeId));
                        const coordName = coords.map(c => c.name).join(', ') || 'غير محدد';
                        
                        const clickHandler = `System.dashboard.showMissingDetails('${missingNames.join("','")}')`;
                        
                        const notifNum = Date.now().toString().slice(-4);
                        const msg = `المكرم المعلم المحترم ${teacher.name} أثناء زيارة فصل ${className} وجدت هذه البنود غير مفعلة (${missingNames.join('، ')}) وبالتالي وجب علينا تنبيهكم لإكمالها وكذلك برفع التقرير مع العلم أن هذه الرسالة إلكترونية من النظام وهذا الاشعار رقم ${notifNum} شاكر لكم ومقدر جهودكم`;

                        tbody.innerHTML += `
                            <tr>
                                <td>${stageName}</td>
                                <td>${className}</td>
                                <td>${teacher.name}</td>
                                <td>${coordName}</td>
                                <td class="text-danger fw-bold cursor-pointer" onclick="${clickHandler}" title="اضغط للتفاصيل">${missingCount}</td>
                                <td>
                                    ${teacher.mobile ? `<button class="btn btn-sm btn-success" onclick="System.utils.sendWhatsapp('${teacher.mobile}', '${teacher.id}', \`${msg}\`, '${missingNames.join(' - ')}')"><i class="fab fa-whatsapp"></i> مراسلة</button>` : '<small>لا يوجد جوال</small>'}
                                </td>
                            </tr>
                        `;
                    }
                });
                
                if(incompleteCount === 0) tbody.innerHTML = '<tr><td colspan="6" class="text-center text-success">جميع الفصول مكتملة الرصد لهذا الأسبوع</td></tr>';
            },
            getGradeId: function(classId) {
                let gid = null;
                System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === classId) gid = g.id; }))));
                return gid;
            },
            showMissingDetails: function(itemsString) {
                const items = itemsString.split(',');
                const content = document.getElementById('missing-items-content');
                content.innerHTML = `<ul class="list-group">${items.map(i => `<li class="list-group-item list-group-item-danger">${i}</li>`).join('')}</ul>`;
                const modal = new bootstrap.Modal(document.getElementById('missingItemsModal'));
                modal.show();
            },
            
            updateStatsFilters: function(level) {
                const schoolSel = document.getElementById('stats-school');
                const gradeSel = document.getElementById('stats-grade');
                const classSel = document.getElementById('stats-class');

                if (level === 'all') {
                    schoolSel.innerHTML = '<option value="all">الجميع</option>';
                    System.data.schools.forEach(s => schoolSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                }
                
                if (level === 'school' || level === 'all') {
                    gradeSel.innerHTML = '<option value="all">الجميع</option>';
                    const sid = schoolSel.value;
                    if (sid !== 'all') {
                         System.data.schools.find(s => s.id == sid)?.stages.forEach(st => st.grades.forEach(g => gradeSel.innerHTML += `<option value="${g.id}">${g.name}</option>`));
                    }
                }
                
                if (level === 'grade' || level === 'all') {
                    classSel.innerHTML = '<option value="all">الجميع</option>';
                    const sid = schoolSel.value;
                    const gid = gradeSel.value;
                    if (sid !== 'all' && gid !== 'all') {
                        let targetGrade = null;
                        System.data.schools.find(s=>s.id == sid)?.stages.forEach(st => {
                            const found = st.grades.find(g => g.id == gid);
                            if(found) targetGrade = found;
                        });
                        if (targetGrade) targetGrade.classes.forEach(c => classSel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
                    }
                }
            },
            renderCriteriaStats: function() {
                 const schoolId = document.getElementById('stats-school').value;
                 const gradeId = document.getElementById('stats-grade').value;
                 const classId = document.getElementById('stats-class').value;
                 
                 let filteredAssignments = System.data.assignments.filter(a => {
                     const teacher = System.data.users.find(u => u.id === a.teacherId);
                     if (!teacher) return false;
                     if (schoolId !== 'all' && teacher.schoolId != schoolId) return false;
                     
                     let foundGid = null;
                     System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => {
                         if (g.classes.find(c => c.id === a.classId)) foundGid = g.id;
                     })));
                     
                     if (gradeId !== 'all' && foundGid != gradeId) return false;
                     if (classId !== 'all' && a.classId != classId) return false;
                     
                     return true;
                 });
                 
                 const relevantEvals = System.data.evaluations.filter(e => filteredAssignments.find(a => a.teacherId === e.teacherId && a.classId === e.classId));
                 const uniqueVisits = new Set(relevantEvals.map(e => `${e.weekId}_${e.classId}_${e.teacherId}`)).size;
                 
                 const tbody = document.querySelector('#criteria-stats-table tbody');
                 tbody.innerHTML = '';
                 
                 if (uniqueVisits === 0) {
                     tbody.innerHTML = '<tr><td colspan="4">لا توجد بيانات تقييم مطابقة للفلاتر</td></tr>';
                     return;
                 }

                 System.data.criteria.forEach(crit => {
                     const actualCount = relevantEvals.filter(e => e.criteriaId === crit.id).length;
                     const percent = Math.round((actualCount / uniqueVisits) * 100);
                     
                     let color = 'success';
                     if (percent < 50) color = 'danger';
                     else if (percent < 80) color = 'warning';

                     tbody.innerHTML += `
                        <tr>
                            <td>${crit.name}</td>
                            <td>${actualCount}</td>
                            <td>${uniqueVisits}</td>
                            <td>
                                <div class="progress position-relative" style="height: 25px;">
                                    <div class="progress-bar bg-${color}" role="progressbar" style="width: ${percent}%"></div>
                                    <span class="position-absolute w-100 text-center text-dark fw-bold" style="top: 2px;">${percent}%</span>
                                </div>
                            </td>
                        </tr>
                      `;
                 });
            }
        },

        // --- UTILS & NOTIFICATIONS ---
        utils: {
            generatePassword: function() { return Math.random().toString(36).slice(-8); },
            sendWhatsapp: function(mobile, teacherId, msg, missingItemsStr) {
                if(!mobile) return;
                const today = new Date();
                const days = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
                
                System.data.notifications.push({
                    id: Date.now(),
                    teacherId: parseInt(teacherId),
                    type: 'whatsapp_alert',
                    date: today.toISOString().split('T')[0],
                    day: days[today.getDay()],
                    details: msg,
                    missing: missingItemsStr
                });
                System.save();
                System.ui.updateNotificationCount();
                
                window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
            },
            printNotification: function(id) {
                const notif = System.data.notifications.find(n => n.id === id);
                if (!notif) return;
                
                const t = System.data.users.find(u => u.id === notif.teacherId)?.name || 'غير معروف';
                const printContainer = document.getElementById('print-area-container');
                
                printContainer.innerHTML = `
                    <div style="border: 2px solid #000; padding: 20px; direction: rtl; text-align: right;">
                        <h3 style="text-align: center; margin-bottom: 20px;">إشعار متابعة</h3>
                        <p><strong>المعلم:</strong> ${t}</p>
                        <p><strong>التاريخ:</strong> ${notif.date}</p>
                        <hr>
                        <p style="font-size: 14pt; line-height: 1.6;">${notif.details}</p>
                        <hr>
                        <p><strong>البنود غير المفعلة:</strong> ${notif.missing || 'لا يوجد تفاصيل إضافية'}</p>
                    </div>
                `;
                
                document.body.classList.add('printing-notification');
                window.print();
                document.body.classList.remove('printing-notification');
            }
        },

        notifications: {
            render: function() {
                const list = document.getElementById('notif-list');
                list.innerHTML = '';
                if(System.data.notifications.length === 0) { list.innerHTML = '<li class="list-group-item">لا توجد إشعارات</li>'; return; }
                
                [...System.data.notifications].reverse().forEach(n => {
                    const t = System.data.users.find(u => u.id === n.teacherId)?.name || 'غير معروف';
                    list.innerHTML += `
                        <li class="list-group-item d-block">
                            <div class="d-flex justify-content-between mb-2">
                                <strong>إشعار للمعلم: ${t}</strong>
                                <div>
                                    <small class="text-muted ms-2">${n.date} (${n.day})</small>
                                    <button class="btn btn-sm btn-outline-dark" onclick="System.utils.printNotification(${n.id})"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <div class="alert alert-light border small text-dark mb-1">
                                ${n.details}
                            </div>
                            ${n.missing ? `<div class="text-danger small fw-bold">البنود الناقصة: ${n.missing}</div>` : ''}
                        </li>
                    `;
                });
            }
        },

        // --- PROCEDURES ---
        procedures: {
            init: function() {
                const tSel = document.getElementById('proc-teacher'); tSel.innerHTML = '';
                const schoolId = System.currentUser.schoolId || System.data.schools[0]?.id;
                System.data.users.filter(u => u.role === 'teacher' && (System.currentUser.role === 'admin' || u.schoolId === System.currentUser.schoolId)).forEach(t => {
                    tSel.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
                this.renderList();
            },
            add: function() {
                const tid = parseInt(document.getElementById('proc-teacher').value);
                const type = document.getElementById('proc-type').value;
                const date = document.getElementById('proc-date').value;
                const day = document.getElementById('proc-day').value;
                const sit = document.getElementById('proc-situation').value;
                const act = document.getElementById('proc-action').value;
                if(!tid || !date || !sit) return alert('البيانات ناقصة');
                System.data.procedures.push({id: Date.now(), teacherId: tid, type, date, day, situation: sit, action: act});
                System.save(); this.renderList(); alert('تم الحفظ');
                document.getElementById('proc-situation').value = ''; document.getElementById('proc-action').value = '';
            },
            renderList: function() {
                const tbody = document.querySelector('#procedures-table tbody'); tbody.innerHTML = '';
                System.data.procedures.forEach(p => {
                    const t = System.data.users.find(u => u.id === p.teacherId)?.name || '-';
                    const typeMap = {'praise':'إفادة شكر', 'note':'ملاحظة', 'verbal_warning':'تنبيه شفهي', 'written_warning':'تنبيه كتابي', 'violation':'مخالفة'};
                    const rowClass = p.type === 'praise' ? 'table-success' : (p.type === 'violation' ? 'table-danger' : '');
                    tbody.innerHTML += `
                        <tr class="${rowClass}">
                            <td>${t}</td><td>${typeMap[p.type]}</td><td>${p.date} (${p.day})</td><td>${p.situation}</td><td>${p.action}</td>
                        </tr>
                    `;
                });
            }
        },

        // --- TEACHER FILE ---
        teacherFile: {
            init: function() {
                const sel = document.getElementById('file-teacher-select'); sel.innerHTML = '<option value="">اختر المعلم...</option>';
                System.data.users.filter(u => u.role === 'teacher' && (System.currentUser.role === 'admin' || u.schoolId === System.currentUser.schoolId)).forEach(t => {
                    sel.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
            },
            render: function() {
                const tid = parseInt(document.getElementById('file-teacher-select').value);
                if(!tid) { document.getElementById('teacher-file-content').classList.add('hidden'); return; }
                document.getElementById('teacher-file-content').classList.remove('hidden');
                
                const t = System.data.users.find(u => u.id === tid);
                document.getElementById('tf-name').innerText = t.name;
                document.getElementById('tf-school').innerText = System.data.schools.find(s=>s.id === t.schoolId)?.name || '';
                
                const procs = System.data.procedures.filter(p => p.teacherId === tid);
                const praiseCount = procs.filter(p => p.type === 'praise').length;
                const violationsCount = procs.filter(p => ['violation', 'verbal_warning', 'written_warning'].includes(p.type)).length;
                
                let gapCountTotal = 0;
                
                // --- 1. GAPS (Shortcomings) TABLE ---
                const gapsTableBody = document.querySelector('#table-gaps tbody'); gapsTableBody.innerHTML = '';
                const weeks = System.data.weeks;
                
                weeks.forEach(w => {
                      const userAssigns = System.data.assignments.filter(a => a.teacherId === tid);
                      userAssigns.forEach(a => {
                          const evals = System.data.evaluations.filter(e => e.teacherId === tid && e.weekId === w.id && e.classId === a.classId);
                          // Check if evaluation happened (at least 1 item checked)
                          if(evals.length > 0 && evals.length < System.data.criteria.length) {
                              const missingCount = System.data.criteria.length - evals.length;
                              const missingItems = System.data.criteria.filter(c => !evals.find(e => e.criteriaId === c.id)).map(c => c.name).join('، ');
                              gapCountTotal += missingCount;
                              
                              let cName = '';
                              System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === a.classId) cName = `${g.name} ${c.name}`; }))));
                              
                              const evalDate = evals[0].date || '-';
                              const perfPercent = Math.round((evals.length / System.data.criteria.length) * 100);

                              gapsTableBody.innerHTML += `
                                <tr>
                                    <td>${cName}</td>
                                    <td>${w.name} <br> <span class="text-muted small">${evalDate}</span></td>
                                    <td class="text-danger fw-bold">${missingCount}</td>
                                    <td>${missingItems}</td>
                                    <td>
                                        <div class="progress progress-thin">
                                            <div class="progress-bar bg-warning" style="width: ${perfPercent}%"></div>
                                        </div>
                                        <small>${perfPercent}%</small>
                                    </td>
                                </tr>`;
                          }
                      });
                });
                if(gapsTableBody.innerHTML === '') gapsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">لا يوجد تقصير مسجل</td></tr>';

                // --- 2. VIOLATIONS TABLE ---
                const violTableBody = document.querySelector('#table-violations tbody'); violTableBody.innerHTML = '';
                const typeMap = {'note':'ملاحظة', 'verbal_warning':'تنبيه شفهي', 'written_warning':'تنبيه كتابي', 'violation':'مخالفة'};
                procs.filter(p => p.type !== 'praise').forEach(p => {
                    violTableBody.innerHTML += `
                        <tr>
                            <td>${typeMap[p.type]}</td>
                            <td>${p.date} (${p.day})</td>
                            <td>${p.situation}</td>
                            <td>${p.action}</td>
                        </tr>`;
                });
                 if(violTableBody.innerHTML === '') violTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">سجل نظيف</td></tr>';

                // --- 3. PRAISE TABLE ---
                const praiseTableBody = document.querySelector('#table-praise tbody'); praiseTableBody.innerHTML = '';
                procs.filter(p => p.type === 'praise').forEach(p => {
                      praiseTableBody.innerHTML += `
                        <tr>
                            <td>عام</td>
                            <td>${p.date}</td>
                            <td>إفادة شكر</td>
                            <td>${p.situation}</td>
                            <td>${p.action}</td>
                        </tr>`;
                });
                if(praiseTableBody.innerHTML === '') praiseTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">لا يوجد سجل ثناء</td></tr>';

                // Update Counters
                document.getElementById('tf-praise-count').innerText = praiseCount;
                document.getElementById('tf-violation-count').innerText = violationsCount;
                document.getElementById('tf-gaps-count').innerText = gapCountTotal;
            }
        },

        // --- REPORTS & CHARTS ---
        reports: {
            init: function() { this.updateFilters('all'); },
            updateFilters: function(trigger) {
                const schoolId = document.getElementById('rep-school').value;
                const stageId = document.getElementById('rep-stage').value;
                if(document.getElementById('rep-school').options.length === 1) System.data.schools.forEach(s => document.getElementById('rep-school').innerHTML += `<option value="${s.id}">${s.name}</option>`);
                if(trigger === 'school' && schoolId !== 'all') {
                    const stSel = document.getElementById('rep-stage'); stSel.innerHTML = '<option value="all">الكل</option>';
                    const school = System.data.schools.find(s => s.id == schoolId);
                    if(school) school.stages.forEach(s => stSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                }
                if(document.getElementById('rep-subject').options.length === 1) {
                    System.data.subjects.forEach(s => document.getElementById('rep-subject').innerHTML += `<option value="${s.id}">${s.name}</option>`);
                    System.data.weeks.forEach(w => document.getElementById('rep-week').innerHTML += `<option value="${w.id}">${w.name}</option>`);
                }
            },
            generate: function() {
                const fSchool = document.getElementById('rep-school').value;
                const fStage = document.getElementById('rep-stage').value;
                const fGrade = document.getElementById('rep-grade').value;
                const fSubject = document.getElementById('rep-subject').value;
                const fWeek = document.getElementById('rep-week').value;

                let users = System.data.users.filter(u => u.role === 'teacher');
                if(fSchool !== 'all') users = users.filter(u => u.schoolId == fSchool);
                if(fSubject !== 'all') users = users.filter(u => u.subjectId == fSubject);
                
                let evals = System.data.evaluations;
                if(fWeek !== 'all') evals = evals.filter(e => e.weekId == fWeek);

                const reportRows = [];
                users.forEach(u => {
                    const teacherEvals = evals.filter(e => e.teacherId === u.id);
                    const score = teacherEvals.length;
                    const distinctWeeks = fWeek !== 'all' ? 1 : ([...new Set(teacherEvals.map(e => e.weekId))].length || 1);
                    const totalPossible = distinctWeeks * System.data.criteria.length; 
                    const percent = totalPossible > 0 ? Math.round((score / (totalPossible * 5)) * 100) : 0; 
                    reportRows.push({
                        school: System.data.schools.find(s=>s.id == u.schoolId)?.name || '-',
                        name: u.name,
                        subject: System.data.subjects.find(s=>s.id == u.subjectId)?.name || '-',
                        score: score,
                        percent: Math.min(100, (score > 0 ? (score / 20) * 100 : 0)) // Normalized approx
                    });
                });

                // 1. Performance Table
                const tbody = document.querySelector('#report-table tbody'); tbody.innerHTML = '';
                if(reportRows.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد بيانات</td></tr>';
                reportRows.forEach(row => {
                    tbody.innerHTML += `<tr><td>${row.school}</td><td>${row.name}</td><td>${row.subject}</td><td>${row.score}</td><td><div class="progress" style="height: 20px;"><div class="progress-bar bg-${row.percent > 80 ? 'success':(row.percent>50?'warning':'danger')}" style="width: ${row.percent}%">${Math.round(row.percent)}%</div></div></td></tr>`;
                });

                // 2. Data Matrix Table
                this.renderDataTable(fSchool, fSubject);

                // 3. Charts
                this.renderCharts(reportRows);
            },
            renderDataTable: function(fSchool, fSubject) {
                const table = document.getElementById('detailed-data-table');
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                
                // Headers: School | Class | Teacher | [Criteria 1] | [Criteria 2] ...
                let headerHTML = `<tr><th>المدرسة</th><th>الفصل</th><th>المعلم</th>`;
                System.data.criteria.forEach(c => headerHTML += `<th>${c.name}</th>`);
                headerHTML += `</tr>`;
                thead.innerHTML = headerHTML;
                tbody.innerHTML = '';

                // Rows
                System.data.assignments.forEach(a => {
                   const t = System.data.users.find(u => u.id === a.teacherId);
                   if(fSchool !== 'all' && t.schoolId != fSchool) return;
                   if(fSubject !== 'all' && t.subjectId != fSubject) return;

                   const sName = System.data.schools.find(s => s.id === t.schoolId)?.name;
                   let cName = '';
                   System.data.schools.forEach(s => s.stages.forEach(st => st.grades.forEach(g => g.classes.forEach(c => { if(c.id === a.classId) cName = `${g.name} ${c.name}`; }))));

                   let rowHTML = `<tr><td>${sName}</td><td>${cName}</td><td>${t.name}</td>`;
                   System.data.criteria.forEach(crit => {
                       const count = System.data.evaluations.filter(e => e.teacherId === t.id && e.classId === a.classId && e.criteriaId === crit.id).length;
                       rowHTML += `<td class="text-center">${count > 0 ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>`;
                   });
                   rowHTML += `</tr>`;
                   tbody.innerHTML += rowHTML;
                });
            },
            renderCharts: function(data) {
                const topData = data.sort((a,b) => b.score - a.score).slice(0, 10);
                
                // Bar Chart
                const ctxBar = document.getElementById('chart-bar');
                if(window.barChartInst) window.barChartInst.destroy();
                window.barChartInst = new Chart(ctxBar, {
                    type: 'bar',
                    data: { labels: topData.map(d => d.name), datasets: [{ label: 'نقاط التفعيل', data: topData.map(d => d.score), backgroundColor: '#0d6efd' }] },
                    options: { responsive: true }
                });

                // Pie Chart (Status Distribution)
                const ctxPie = document.getElementById('chart-pie');
                const high = data.filter(d => d.percent > 80).length;
                const med = data.filter(d => d.percent <= 80 && d.percent > 50).length;
                const low = data.filter(d => d.percent <= 50).length;
                if(window.pieChartInst) window.pieChartInst.destroy();
                window.pieChartInst = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: { labels: ['متميز', 'متوسط', 'ضعيف'], datasets: [{ data: [high, med, low], backgroundColor: ['#198754', '#ffc107', '#dc3545'] }] }
                });

                // Line Chart (Trends - Mock Data based on weeks)
                const ctxLine = document.getElementById('chart-line');
                const weekLabels = System.data.weeks.map(w => w.name);
                const weekData = System.data.weeks.map(w => System.data.evaluations.filter(e => e.weekId === w.id).length);
                if(window.lineChartInst) window.lineChartInst.destroy();
                window.lineChartInst = new Chart(ctxLine, {
                    type: 'line',
                    data: { labels: weekLabels, datasets: [{ label: 'إجمالي عمليات الرصد', data: weekData, borderColor: '#6610f2', fill: false }] }
                });
            }
        }
    };

    window.onload = function() { System.init(); };
    </script>
</body>
</html>